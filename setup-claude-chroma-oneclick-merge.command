#!/usr/bin/env bash
# Claude-Chroma One-Click Setup for macOS (Fixed Version)
# Just double-click this file to set up ChromaDB for this directory!
# Version: 3.5.3-oneclick-fixed

set -euo pipefail

# Get the directory where this script is located (where user double-clicked)
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_DIR="$SCRIPT_DIR"
PROJECT_NAME="$(basename "$PROJECT_DIR")"

# Colors for output
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'
readonly BOLD='\033[1m'

# Create temporary directory for extraction
TEMP_DIR="$(mktemp -d)"
trap "rm -rf '$TEMP_DIR'" EXIT

clear
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${YELLOW}🚀 Claude-Chroma One-Click Setup${NC}"
echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "${BLUE}Setting up ChromaDB for:${NC}"
echo "  📁 Project: $PROJECT_NAME"
echo "  📍 Location: $PROJECT_DIR"
echo ""
echo "Please wait while we configure everything automatically..."
echo ""

# Extract embedded claude-chroma.sh
echo -e "${BLUE}⏳ Extracting setup script...${NC}"
base64 -d > "$TEMP_DIR/claude-chroma.sh" <<'SCRIPT_BASE64'
IyEvYmluL2Jhc2gKIyBDaHJvbWFEQiBzZXR1cCBmb3IgQ2xhdWRlIHByb2plY3RzIC0gUHJvZHVjdGlvbi1yZWFkeSB2ZXJzaW9uCiMgVmVyc2lvbiAzLjUuMwojIHYzLjUuMyBDaGFuZ2VzOgojIC0gRXh0ZXJuYWxpemVkIENMQVVERS5tZCB0byB0ZW1wbGF0ZXMvQ0xBVURFLm1kLnRwbCByZW5kZXJlZCB2aWEgZW52c3Vic3QKIyAtIFNoZWxsIGZ1bmN0aW9uIGluc3RhbGxlciBnYXRlZCBiZWhpbmQgLS1mdWxsCiMgLSBEZWZhdWx0czogbWluaW1hbD0xLCBmdWxsPTAKIyB2My40LjIgQ2hhbmdlczoKIyAtIEFkZGVkIFJFQUQtT05MWSBkZXRlY3Rpb24gb2YgZ2xvYmFsIG1lbW9yeSBjaGVja3BvaW50IHJ1bGVzCiMgLSBORVZFUiBtb2RpZmllcyBnbG9iYWwgfi8uY2xhdWRlL0NMQVVERS5tZCAoc2FmZXR5IGd1YXJhbnRlZWQpCiMgLSBDcmVhdGVzIGxvY2FsIE1FTU9SWV9DSEVDS1BPSU5UX1JFTUlOREVSLm1kIGlmIGdsb2JhbCBsYWNrcyBydWxlcwojIC0gRW5zdXJlcyBtZW1vcnkgZGlzY2lwbGluZSB3aXRob3V0IHRvdWNoaW5nIGdsb2JhbCBjb25maWd1cmF0aW9uCiMgdjMuNC4xIENoYW5nZXM6CiMgLSBSZXN0b3JlZCBtZW1vcnkgY2hlY2twb2ludCBydWxlcyB0aGF0IHdlcmUgYWNjaWRlbnRhbGx5IHJlbW92ZWQgaW4gMy40LjAKIyAtIEFkZGVkIGV4cGxpY2l0IHJlbWluZGVycyBmb3IgbG9uZyBjb2Rpbmcgc2Vzc2lvbnMgKD4xMCBpbnRlcmFjdGlvbnMpCiMgLSBFbmhhbmNlZCBhY3RpdmF0aW9uIHNlY3Rpb24gd2l0aCBtZW1vcnkgaW50ZXJuYWxpemF0aW9uIHN0ZXBzCiMgdjMuNC4wIENoYW5nZXM6CiMgLSBSZXBsYWNlZCBiYXNpYyBDaHJvbWFEQi1vbmx5IHRlbXBsYXRlIHdpdGggY29tcHJlaGVuc2l2ZSBwcm9qZWN0IGNvbnRyYWN0CiMgLSBBZGRlZCB0b29sIHNlbGVjdGlvbiBtYXRyaXgsIGFkZGl0aW9uYWwgTUNQIHNlcnZlcnMsIHNlc3Npb24gbGlmZWN5Y2xlCiMgLSBJbmNsdWRlcyBicm93c2VyIGF1dG9tYXRpb24sIEdpdEh1YiB3b3JrZmxvdywgcXVhbGl0eSBnYXRlcwojIHYzLjMuNiBDaGFuZ2VzOgojIC0gQWRkZWQgaW5zdHJ1Y3Rpb24gdG8gcXVlcnkgZXhpc3RpbmcgbWVtb3JpZXMgYXQgc2Vzc2lvbiBzdGFydAojIC0gQ2xhdWRlIG5vdyBhdXRvbWF0aWNhbGx5IHJldmlld3MgcHJvamVjdCBjb250ZXh0IHdoZW4gc3RhcnRpbmcKIyAtIEJldHRlciBjb250aW51aXR5IGJldHdlZW4gc2Vzc2lvbnMKIyB2My4zLjUgQ2hhbmdlczoKIyAtIFVwZGF0ZWQgQ0xBVURFLm1kIHRvIGhhbmRsZSBDaHJvbWFEQiByZXR1cm5pbmcgTm9uZSBvbiBzdWNjZXNzCiMgLSBDaGFuZ2VkIG1lbW9yeSBsb2dnaW5nIGluc3RydWN0aW9uIHRvIG5vdCBleHBlY3QgSUQgYmFjawojIC0gQ2xlYXJlciBzdWNjZXNzIGNvbmZpcm1hdGlvbiB3aXRob3V0IHNob3dpbmcgJ05vbmUnIHJlc3VsdAojIHYzLjMuNCBDaGFuZ2VzOgojIC0gRml4ZWQgQ0xBVURFLm1kIGNhdXNpbmcgQ2xhdWRlIHRvIGF1dG8tdHlwZSAnY2hhdCcKIyAtIENoYW5nZWQgJ1JlYWQgdGhpcyBmaWxlIGF0IGNoYXQgc3RhcnQnIHRvICdSZWFkIHRoaXMgZmlsZSBhdCBzZXNzaW9uIHN0YXJ0JwojIC0gQ2hhbmdlZCAnRm9sbG93IHRoaXMgaW4gZXZlcnkgY2hhdCcgdG8gJ0ZvbGxvdyB0aGlzIGluIGV2ZXJ5IHNlc3Npb24nCiMgdjMuMy4zIENoYW5nZXM6CiMgLSBQcmV2aW91c2x5IHVzZWQgJ2NsYXVkZSBjaGF0JyBidXQgcmVtb3ZlZCB0byBwcmV2ZW50IGF1dG8tdHlwaW5nIGJ1ZwojIC0gQWRkZWQgZXhwbGljaXQgbm90ZSB0byBwcmV2ZW50IHVzZXJzIGZyb20gdHlwaW5nICdjaGF0JyBhZnRlciBzdGFydGluZyBjbGF1ZGUKIyAtIEltcHJvdmVkIGxhdW5jaGVyIHNjcmlwdCBtZXNzYWdpbmcKIyB2My4zLjIgQ2hhbmdlczoKIyAtIEltcHJvdmVkIENMQVVERS5tZCBoYW5kbGluZyB0byBwcmVzZXJ2ZSBleGlzdGluZyB1c2VyIGluc3RydWN0aW9ucwojIC0gQ3JlYXRlcyBDTEFVREUubWQub3JpZ2luYWwgYmFja3VwIGZvciBlYXN5IHJlZmVyZW5jZQojIC0gTm8gbG9uZ2VyIHByb21wdHMgdG8gb3ZlcndyaXRlLCBhdXRvbWF0aWNhbGx5IGJhY2tzIHVwIGV4aXN0aW5nIGNvbnRlbnQKIyAtIEFkZHMgY2xlYXIgbWVzc2FnaW5nIGFib3V0IHdoZXJlIG9yaWdpbmFsIGluc3RydWN0aW9ucyBhcmUgcHJlc2VydmVkCiMgdjMuMy4xIENoYW5nZXM6CiMgLSBSZWxheGVkIGNoYXJhY3RlciB2YWxpZGF0aW9uIHRvIGFsbG93IGFwb3N0cm9waGVzLCBicmFja2V0cywgcGFyZW50aGVzZXMKIyAtIE5vdyBvbmx5IGJsb2NrcyBiYWNrdGlja3MgYW5kICQgZm9yIGNvbW1hbmQgc3Vic3RpdHV0aW9uIHByZXZlbnRpb24KIyAtIEZpeGVzIHN1cHBvcnQgZm9yIHBhdGhzIGxpa2UgIkpvaG4ncyBEb2N1bWVudHMiIGFuZCAiRmlsZXMgWzIwMjVdIgojIHYzLjMuMCBDaGFuZ2VzOgojIC0gQWRkZWQgaW5maW5pdGUgdGltZW91dCBzZXR0aW5ncyB0byBwcmV2ZW50IHNlc3Npb24gZGlzY29ubmVjdGlvbnMKIyAtIEF1dG8tZGV0ZWN0IGFuZCBmaXggYnJva2VuIHNoZWxsIGZ1bmN0aW9ucyBmcm9tIG9sZGVyIHZlcnNpb25zCiMgLSBWYWxpZGF0ZSBhbmQgdXBkYXRlIGV4aXN0aW5nIC5tY3AuanNvbiBmaWxlcyB3aXRob3V0IHRpbWVvdXQgc2V0dGluZ3MKIyAtIE1hZGUgc2NyaXB0IGZ1bGx5IHNlbGYtY29udGFpbmVkIGZvciBwb3J0YWJsZSBkZXBsb3ltZW50cwojIFByZXZpb3VzIHYzLjIgZmVhdHVyZXM6CiMgLSBGaXhlZCBwYXRoIHZhbGlkYXRpb24gdG8gYWxsb3cgc3BhY2VzCiMgLSBBZGRlZCBjb21wcmVoZW5zaXZlIGlucHV0IHNhbml0aXphdGlvbgojIC0gQXRvbWljIHdyaXRlcyB3aXRoIGF1dG9tYXRpYyBiYWNrdXBzCiMgLSBTYWZlIEpTT04gZ2VuZXJhdGlvbiBhbmQgdmFsaWRhdGlvbgojIC0gUHJvcGVyIHJvbGxiYWNrIG9uIGZhaWx1cmUKIyAtIERyeS1ydW4gbW9kZSBzdXBwb3J0CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBTQUZFVFkgUkFJTFMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CnNldCAtRWV1byBwaXBlZmFpbApJRlM9JCdcblx0Jwp1bWFzayAwNzcKCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIEdMT0JBTFMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CnJlYWRvbmx5IFNDUklQVF9WRVJTSU9OPSIzLjUuMyIKCiMgb3B0LWluIGZsYWdzIChkZWZhdWx0IGxlYW4pCk1JTklNQUw9IiR7TUlOSU1BTDotMX0iCkZVTEw9IiR7RlVMTDotMH0iCnJlYWRvbmx5IENIUk9NQV9NQ1BfVkVSU0lPTj0iJHtDSFJPTUFfTUNQX1ZFUlNJT046LWNocm9tYS1tY3A9PTAuMi4wfSIKCiMgRW52aXJvbm1lbnQgZmxhZ3MKRFJZX1JVTj0iJHtEUllfUlVOOi0wfSIKTk9OX0lOVEVSQUNUSVZFPSIke05PTl9JTlRFUkFDVElWRTotMH0iCkFTU1VNRV9ZRVM9IiR7QVNTVU1FX1lFUzotMH0iCkRFQlVHPSIke0RFQlVHOi0wfSIKCiMgVHJhY2sgZmlsZXMgZm9yIHJvbGxiYWNrClRPVUNIRURfRklMRVM9KCkKQ0xFQU5VUF9GSUxFUz0oKQoKIyBDb2xvcnMgZm9yIG91dHB1dApyZWFkb25seSBSRUQ9J1wwMzNbMDszMW0nCnJlYWRvbmx5IEdSRUVOPSdcMDMzWzA7MzJtJwpyZWFkb25seSBZRUxMT1c9J1wwMzNbMTszM20nCnJlYWRvbmx5IEJMVUU9J1wwMzNbMDszNG0nCnJlYWRvbmx5IE5DPSdcMDMzWzBtJyAjIE5vIENvbG9yCgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBFUlJPUiBIQU5ETElORyAmIENMRUFOVVAKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09Cm9uX2VycigpIHsKICAgIGxvY2FsIGV4aXRfY29kZT0kPwogICAgaWYgW1sgJGV4aXRfY29kZSAtbmUgMCBdXTsgdGhlbgogICAgICAgIHByaW50X2Vycm9yICJTZXR1cCBmYWlsZWQgKGV4aXQgY29kZTogJGV4aXRfY29kZSkuIFJvbGxpbmcgYmFjayBjaGFuZ2VzLi4uIgogICAgICAgIHJvbGxiYWNrX2NoYW5nZXMKICAgIGZpCn0KCnJvbGxiYWNrX2NoYW5nZXMoKSB7CiAgICBpZiBbWyAkeyNUT1VDSEVEX0ZJTEVTW0BdfSAtZ3QgMCBdXTsgdGhlbgogICAgICAgIGZvciBmaWxlIGluICIke1RPVUNIRURfRklMRVNbQF19IjsgZG8KICAgICAgICAgICAgaWYgY29tcGdlbiAtRyAiJGZpbGUuYmFja3VwLioiID4vZGV2L251bGw7IHRoZW4KICAgICAgICAgICAgICAgIGxvY2FsIGxhdGVzdF9iYWNrdXAKICAgICAgICAgICAgICAgIGxhdGVzdF9iYWNrdXA9JChscyAtdCAiJGZpbGUuYmFja3VwLiIqIDI+L2Rldi9udWxsIHwgaGVhZCAtMSB8fCB0cnVlKQogICAgICAgICAgICAgICAgW1sgLW4gIiRsYXRlc3RfYmFja3VwIiBdXSAmJiBtdiAtZiAiJGxhdGVzdF9iYWNrdXAiICIkZmlsZSIgMj4vZGV2L251bGwgJiYgXAogICAgICAgICAgICAgICAgICAgIHByaW50X2luZm8gIlJlc3RvcmVkOiAkZmlsZSIgfHwgdHJ1ZQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBybSAtZiAiJGZpbGUiIDI+L2Rldi9udWxsICYmIFwKICAgICAgICAgICAgICAgICAgICBwcmludF9pbmZvICJSZW1vdmVkOiAkZmlsZSIgfHwgdHJ1ZQogICAgICAgICAgICBmaQogICAgICAgIGRvbmUKICAgIGZpCgogICAgaWYgW1sgJHsjQ0xFQU5VUF9GSUxFU1tAXX0gLWd0IDAgXV07IHRoZW4KICAgICAgICBmb3IgdGVtcF9maWxlIGluICIke0NMRUFOVVBfRklMRVNbQF19IjsgZG8KICAgICAgICAgICAgcm0gLWYgIiR0ZW1wX2ZpbGUiIDI+L2Rldi9udWxsIHx8IHRydWUKICAgICAgICBkb25lCiAgICBmaQp9CgpjbGVhbnVwX29uX2V4aXQoKSB7CiAgICBsb2NhbCBleGl0X2NvZGU9JD8KICAgIGlmIFtbICRleGl0X2NvZGUgLW5lIDAgXV07IHRoZW4KICAgICAgICBvbl9lcnIKICAgIGZpCgogICAgIyBDbGVhbiB0ZW1wb3JhcnkgZmlsZXMgcmVnYXJkbGVzcyBvZiBleGl0IHN0YXR1cwogICAgaWYgW1sgJHsjQ0xFQU5VUF9GSUxFU1tAXX0gLWd0IDAgXV07IHRoZW4KICAgICAgICBmb3IgdGVtcF9maWxlIGluICIke0NMRUFOVVBfRklMRVNbQF19IjsgZG8KICAgICAgICAgICAgcm0gLWYgIiR0ZW1wX2ZpbGUiIDI+L2Rldi9udWxsIHx8IHRydWUKICAgICAgICBkb25lCiAgICBmaQp9Cgp0cmFwIGNsZWFudXBfb25fZXhpdCBFWElUCnRyYXAgb25fZXJyIEVSUgoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgT1VUUFVUIEZVTkNUSU9OUwojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KcHJpbnRfc3RhdHVzKCkgewogICAgZWNobyAtZSAiJHtHUkVFTn3inJMke05DfSAkMSIKfQoKcHJpbnRfZXJyb3IoKSB7CiAgICBlY2hvIC1lICIke1JFRH3inJcke05DfSAkMSIgPiYyCn0KCnByaW50X2luZm8oKSB7CiAgICBlY2hvIC1lICIke0JMVUV94oS5JHtOQ30gJDEiCn0KCnByaW50X3dhcm5pbmcoKSB7CiAgICBlY2hvIC1lICIke1lFTExPV33imqAke05DfSAkMSIKfQoKcHJpbnRfaGVhZGVyKCkgewogICAgZWNobyAtZSAiXG4ke1lFTExPV33ilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEke05DfSIKICAgIGVjaG8gLWUgIiR7WUVMTE9XfSQxJHtOQ30iCiAgICBlY2hvIC1lICIke1lFTExPV33ilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIHilIEke05DfVxuIgp9CgpkZWJ1Z19sb2coKSB7CiAgICBbWyAiJERFQlVHIiA9PSAiMSIgXV0gJiYgZWNobyAtZSAiJHtCTFVFfVtERUJVR10ke05DfSAkMSIgPiYyIHx8IHRydWUKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgUEFUSCBTQUZFVFkgRlVOQ1RJT05TCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpyZXF1aXJlX3JlYWxwYXRoKCkgewogICAgaWYgY29tbWFuZCAtdiByZWFscGF0aCA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICByZWFscGF0aCAiJDEiCiAgICBlbGlmIGNvbW1hbmQgLXYgcHl0aG9uMyA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBweXRob24zIC0gPDwnUFknICIkMSIKaW1wb3J0IG9zLHN5czsgcHJpbnQob3MucGF0aC5yZWFscGF0aChzeXMuYXJndlsxXSkpClBZCiAgICBlbHNlCiAgICAgICAgZWNobyAiJChjZCAiJChkaXJuYW1lICIkMSIpIiAyPi9kZXYvbnVsbCAmJiBwd2QpLyQoYmFzZW5hbWUgIiQxIikiCiAgICBmaQp9Cgphc3NlcnRfd2l0aGluKCkgewogICAgbG9jYWwgY2hpbGQ9IiQocmVxdWlyZV9yZWFscGF0aCAiJDEiKSIKICAgIGxvY2FsIHBhcmVudD0iJChyZXF1aXJlX3JlYWxwYXRoICIkMiIpIgogICAgY2FzZSAiJGNoaWxkIiBpbgogICAgICAgICIkcGFyZW50Ii8qfCIkcGFyZW50IikgOzsKICAgICAgICAqKQogICAgICAgICAgICBwcmludF9lcnJvciAiUGF0aCBlc2NhcGVzIHByb2plY3QiCiAgICAgICAgICAgIHByaW50X2luZm8gIkNoaWxkOiAkY2hpbGQiCiAgICAgICAgICAgIHByaW50X2luZm8gIlJvb3Q6ICRwYXJlbnQiCiAgICAgICAgICAgIGV4aXQgMQogICAgICAgICAgICA7OwogICAgZXNhYwp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBJTlBVVCBWQUxJREFUSU9OICYgU0FOSVRJWkFUSU9OCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFNlY3VyaXR5IE1vZGVsOgojIC0gV2Ugb25seSBibG9jayBjaGFyYWN0ZXJzIHRoYXQgZW5hYmxlIGNvbW1hbmQgZXhlY3V0aW9uIChiYWNrdGlja3MsICQpCiMgLSBBcG9zdHJvcGhlcywgcXVvdGVzLCBicmFja2V0cywgcGFyZW50aGVzZXMgYXJlIFNBRkUgd2hlbiBwcm9wZXJseSBxdW90ZWQKIyAtIFRoZSBzY3JpcHQgdXNlcyBwcm9wZXIgcXVvdGluZyBldmVyeXdoZXJlOiAiJFZBUiIgaW4gc2hlbGwsIGpxIC0tYXJnIGZvciBKU09OCiMgLSBUaGlzIGFsbG93cyBsZWdpdGltYXRlIHBhdGhzIGxpa2UgIkpvaG4ncyBEb2N1bWVudHMiIG9yICJGaWxlcyBbMjAyNV0iCiMKIyBQcmV2aW91cyBvdmVybHktc3RyaWN0IHBhdHRlcm4gdGhhdCBibG9ja2VkIHRvbyBtYW55IHZhbGlkIGNoYXJhY3RlcnM6CiMgcmVhZG9ubHkgZGFuZ2Vyb3VzX2NoYXJfY2xhc3M9J1tgJCgpe31bXF08PnwmOyJdJwojCiMgTWluaW1hbCBwYXR0ZXJuIC0gYmxvY2tzIG9ubHkgY29tbWFuZCBzdWJzdGl0dXRpb24gcmlza3M6CnJlYWRvbmx5IGRhbmdlcm91c19jaGFyX2NsYXNzPSdbYCRdJwojIE5vdGU6IENvdWxkIGJlIGV2ZW4gbW9yZSBwZXJtaXNzaXZlIHdpdGgganVzdCAnW2BdJyBpZiAkIGluIHBhdGhzIG5lZWRlZAoKc2FuaXRpemVfaW5wdXQoKSB7CiAgICAjIFN0cmlwcyB0cmF2ZXJzYWwgYXR0ZW1wdHMgYW5kIGRhbmdlcm91cyBjaGFyYWN0ZXJzCiAgICBsb2NhbCBpbnB1dD0iJHsxOi19IgoKICAgICMgUmVtb3ZlIGRpcmVjdG9yeSB0cmF2ZXJzYWwgYXR0ZW1wdHMKICAgIGlucHV0PSIke2lucHV0Ly8uLlwvfSIKICAgIGlucHV0PSIke2lucHV0Ly9cLy4uXC8vXC99IgoKICAgICMgUmVtb3ZlIGRhbmdlcm91cyBtZXRhY2hhcmFjdGVycyBidXQga2VlcCBzcGFjZXMKICAgIGlucHV0PSIke2lucHV0Ly9bJGRhbmdlcm91c19jaGFyX2NsYXNzXS99IgoKICAgIHByaW50ZiAnJXMnICIkaW5wdXQiCn0KCnZhbGlkYXRlX3BhdGgoKSB7CiAgICBsb2NhbCBwYXRoPSIkezE6LX0iCgogICAgIyBBbGxvdyBzcGFjZXMgYnV0IGZvcmJpZCB0cnVseSBkYW5nZXJvdXMgbWV0YWNoYXJhY3RlcnMKICAgIGlmIFtbICIkcGF0aCIgPX4gWyRkYW5nZXJvdXNfY2hhcl9jbGFzc10gXV07IHRoZW4KICAgICAgICBwcmludF9lcnJvciAiSW52YWxpZCBwYXRoOiBjb250YWlucyBjb21tYW5kIGV4ZWN1dGlvbiBjaGFyYWN0ZXJzIgogICAgICAgIHByaW50X2luZm8gIlBhdGg6ICRwYXRoIgogICAgICAgIHByaW50X2luZm8gIlJlbW92ZSB0aGVzZSBjaGFyYWN0ZXJzOiBcYCBcJCAoYmFja3RpY2sgYW5kIGRvbGxhciBzaWduKSIKICAgICAgICBwcmludF9pbmZvICJUaGVzZSBlbmFibGUgY29tbWFuZCBzdWJzdGl0dXRpb24gYW5kIG11c3QgYmUgYmxvY2tlZCBmb3Igc2VjdXJpdHkiCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCgogICAgIyBDaGVjayBmb3IgZGlyZWN0b3J5IHRyYXZlcnNhbAogICAgaWYgW1sgIiRwYXRoIiA9fiBcLlwuIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfZXJyb3IgIkludmFsaWQgcGF0aDogY29udGFpbnMgZGlyZWN0b3J5IHRyYXZlcnNhbCIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICByZXR1cm4gMAp9Cgp2YWxpZGF0ZV9wcm9qZWN0X25hbWUoKSB7CiAgICBsb2NhbCBuYW1lPSIkezE6LX0iCgogICAgIyBQcm9qZWN0IG5hbWVzIHNob3VsZCBiZSBzaW1wbGUKICAgIGlmIFtbICEgIiRuYW1lIiA9fiBeW2EtekEtWjAtOV1bYS16QS1aMC05Ll8tXSokIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfZXJyb3IgIkludmFsaWQgcHJvamVjdCBuYW1lOiAkbmFtZSIKICAgICAgICBwcmludF9pbmZvICJVc2Ugb25seSBsZXR0ZXJzLCBudW1iZXJzLCBkb3RzLCB1bmRlcnNjb3JlcywgYW5kIGh5cGhlbnMiCiAgICAgICAgcHJpbnRfaW5mbyAiTXVzdCBzdGFydCB3aXRoIGEgbGV0dGVyIG9yIG51bWJlciIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICByZXR1cm4gMAp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBGSUxFIE9QRVJBVElPTlMKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmJhY2t1cF9pZl9leGlzdHMoKSB7CiAgICBsb2NhbCBmaWxlPSIkMSIKICAgIGlmIFtbIC1mICIkZmlsZSIgXV07IHRoZW4KICAgICAgICBsb2NhbCBiYWNrdXBfbmFtZT0iJGZpbGUuYmFja3VwLiQoZGF0ZSArJVklbSVkXyVIJU0lUykiCiAgICAgICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICAgICAgcHJpbnRfaW5mbyAiW2RyeS1ydW5dIFdvdWxkIGJhY2t1cCAkZmlsZSB0byAkYmFja3VwX25hbWUiCiAgICAgICAgZWxzZQogICAgICAgICAgICBjcCAtcCAiJGZpbGUiICIkYmFja3VwX25hbWUiICYmIFwKICAgICAgICAgICAgICAgIGRlYnVnX2xvZyAiQmFja2VkIHVwOiAkZmlsZSDihpIgJGJhY2t1cF9uYW1lIgogICAgICAgICAgICAjIFBydW5lIG9sZCBiYWNrdXBzIChrZWVwIGxhc3QgNSkKICAgICAgICAgICAgcHJ1bmVfYmFja3VwcyAiJGZpbGUiCiAgICAgICAgZmkKICAgIGZpCn0KCiMgUHJ1bmUgb2xkIGJhY2t1cHMga2VlcGluZyBvbmx5IHRoZSBsYXN0IE4KcHJ1bmVfYmFja3VwcygpIHsKICAgIGxvY2FsIGZpbGU9IiQxIgogICAgbG9jYWwga2VlcD0iJHtCQUNLVVBfS0VFUDotNX0iCgogICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICBkZWJ1Z19sb2cgIltkcnktcnVuXSBXb3VsZCBwcnVuZSBiYWNrdXBzIGZvciAkZmlsZSAoa2VlcGluZyAka2VlcCkiCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgICMgTGlzdCBiYWNrdXBzIHNvcnRlZCBieSB0aW1lLCByZW1vdmUgb2xkZXN0IGlmID4gJGtlZXAKICAgIGxvY2FsIGNvdW50PTAKICAgIGxzIC10ICIke2ZpbGV9LmJhY2t1cC4iKiAyPi9kZXYvbnVsbCB8IHdoaWxlIHJlYWQgLXIgYmFja3VwOyBkbwogICAgICAgICgoY291bnQrKykpCiAgICAgICAgaWYgW1sgJGNvdW50IC1ndCAka2VlcCBdXTsgdGhlbgogICAgICAgICAgICBkZWJ1Z19sb2cgIlJlbW92aW5nIG9sZCBiYWNrdXA6ICRiYWNrdXAiCiAgICAgICAgICAgIHJtIC1mICIkYmFja3VwIgogICAgICAgIGZpCiAgICBkb25lCn0KCiMgU3BlY2lhbCBiYWNrdXAgZm9yIENMQVVERS5tZCB0aGF0IHByZXNlcnZlcyB1c2VyIGNvbnRlbnQgY2xlYXJseQpiYWNrdXBfY2xhdWRlX21kKCkgewogICAgaWYgW1sgLWYgIkNMQVVERS5tZCIgXV07IHRoZW4KICAgICAgICAjIENyZWF0ZSB0aW1lc3RhbXBlZCBiYWNrdXAgZm9yIHNhZmV0eQogICAgICAgIGxvY2FsIHRpbWVzdGFtcGVkX2JhY2t1cD0iQ0xBVURFLm1kLmJhY2t1cC4kKGRhdGUgKyVZJW0lZF8lSCVNJVMpIgoKICAgICAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgYmFja3VwIENMQVVERS5tZCB0bzoiCiAgICAgICAgICAgIHByaW50X2luZm8gIiAg4oaSICR0aW1lc3RhbXBlZF9iYWNrdXAgKHRpbWVzdGFtcGVkIHNhZmV0eSBiYWNrdXApIgogICAgICAgICAgICBwcmludF9pbmZvICIgIOKGkiBDTEFVREUubWQub3JpZ2luYWwgKGZvciBlYXN5IHJlZmVyZW5jZSkiCiAgICAgICAgZWxzZQogICAgICAgICAgICAjIENyZWF0ZSB0aW1lc3RhbXBlZCBiYWNrdXAKICAgICAgICAgICAgY3AgLXAgIkNMQVVERS5tZCIgIiR0aW1lc3RhbXBlZF9iYWNrdXAiICYmIFwKICAgICAgICAgICAgICAgIGRlYnVnX2xvZyAiQ3JlYXRlZCB0aW1lc3RhbXBlZCBiYWNrdXA6ICR0aW1lc3RhbXBlZF9iYWNrdXAiCgogICAgICAgICAgICAjIEFsc28gY3JlYXRlL3VwZGF0ZSAub3JpZ2luYWwgZm9yIGVhc3kgdXNlciByZWZlcmVuY2UKICAgICAgICAgICAgY3AgLXAgIkNMQVVERS5tZCIgIkNMQVVERS5tZC5vcmlnaW5hbCIgJiYgXAogICAgICAgICAgICAgICAgZGVidWdfbG9nICJDcmVhdGVkIHJlZmVyZW5jZSBjb3B5OiBDTEFVREUubWQub3JpZ2luYWwiCgogICAgICAgICAgICBwcmludF9pbmZvICLwn5OBIFByZXNlcnZlZCB5b3VyIGV4aXN0aW5nIENMQVVERS5tZDoiCiAgICAgICAgICAgIHByaW50X2luZm8gIiAg4oaSIENMQVVERS5tZC5vcmlnaW5hbCAoeW91ciBjdXN0b20gaW5zdHJ1Y3Rpb25zKSIKICAgICAgICAgICAgcHJpbnRfaW5mbyAiICDihpIgJHRpbWVzdGFtcGVkX2JhY2t1cCAodGltZXN0YW1wZWQgYmFja3VwKSIKICAgICAgICBmaQogICAgICAgIHJldHVybiAwCiAgICBmaQogICAgcmV0dXJuIDEKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgTUVNT1JZIERJU0NJUExJTkUgQ0hFQ0tTIChSRUFELU9OTFkgZm9yIGdsb2JhbCBmaWxlcykKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgVGhlc2UgZnVuY3Rpb25zIE5FVkVSIG1vZGlmeSBnbG9iYWwgfi8uY2xhdWRlL0NMQVVERS5tZAojIFRoZXkgb25seSByZWFkIHRvIGNoZWNrIHN0YXR1cyBhbmQgY3JlYXRlIGxvY2FsIHByb2plY3QgcmVtaW5kZXJzIGlmIG5lZWRlZAoKY2hlY2tfZ2xvYmFsX21lbW9yeV9ydWxlcygpIHsKICAgICMgUkVBRC1PTkxZIGNoZWNrIGlmIGdsb2JhbCBDTEFVREUubWQgaGFzIG1lbW9yeSBjaGVja3BvaW50IHJ1bGVzCiAgICAjIFJldHVybnM6IDAgaWYgcnVsZXMgZXhpc3QsIDEgaWYgbm90LCAyIGlmIGZpbGUgZG9lc24ndCBleGlzdAoKICAgIGxvY2FsIHJlYWRvbmx5IEdMT0JBTF9ESVI9IiR7WERHX0NPTkZJR19IT01FOi0kSE9NRS8uY2xhdWRlfSIKICAgIGxvY2FsIHJlYWRvbmx5IEdMT0JBTF9DTEFVREU9IiRHTE9CQUxfRElSL0NMQVVERS5tZCIKCiAgICAjIENoZWNrIGlmIGdsb2JhbCBmaWxlIGV4aXN0cyAoUkVBRC1PTkxZKQogICAgaWYgW1sgISAtZiAiJEdMT0JBTF9DTEFVREUiIF1dOyB0aGVuCiAgICAgICAgZGVidWdfbG9nICJHbG9iYWwgQ0xBVURFLm1kIG5vdCBmb3VuZCBhdCAkR0xPQkFMX0NMQVVERSIKICAgICAgICByZXR1cm4gMgogICAgZmkKCiAgICAjIENoZWNrIGlmIGZpbGUgaXMgcmVhZGFibGUgKG5vIG1vZGlmaWNhdGlvbiBhdHRlbXB0KQogICAgaWYgW1sgISAtciAiJEdMT0JBTF9DTEFVREUiIF1dOyB0aGVuCiAgICAgICAgZGVidWdfbG9nICJHbG9iYWwgQ0xBVURFLm1kIGV4aXN0cyBidXQgbm90IHJlYWRhYmxlIgogICAgICAgIHJldHVybiAyCiAgICBmaQoKICAgICMgUkVBRC1PTkxZIGdyZXAgY2hlY2sgZm9yIG1lbW9yeSBjaGVja3BvaW50IHJ1bGVzCiAgICBpZiBncmVwIC1xICJNZW1vcnkgQ2hlY2twb2ludCBSdWxlcyIgIiRHTE9CQUxfQ0xBVURFIiAyPi9kZXYvbnVsbDsgdGhlbgogICAgICAgIGRlYnVnX2xvZyAiTWVtb3J5IGNoZWNrcG9pbnQgcnVsZXMgZm91bmQgaW4gZ2xvYmFsIENMQVVERS5tZCIKICAgICAgICByZXR1cm4gMAogICAgZWxzZQogICAgICAgIGRlYnVnX2xvZyAiTWVtb3J5IGNoZWNrcG9pbnQgcnVsZXMgTk9UIGZvdW5kIGluIGdsb2JhbCBDTEFVREUubWQiCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCn0KCmNyZWF0ZV9tZW1vcnlfcmVtaW5kZXJfZG9jKCkgewogICAgIyBDcmVhdGVzIGEgTE9DQUwgcHJvamVjdCBmaWxlIHdpdGggbWVtb3J5IHJlbWluZGVycwogICAgIyBOZXZlciB0b3VjaGVzIGdsb2JhbCBmaWxlcwoKICAgIHByaW50X2luZm8gIkNyZWF0aW5nIGxvY2FsIG1lbW9yeSByZW1pbmRlciBkb2N1bWVudC4uLiIKCiAgICBsb2NhbCBjb250ZW50PScjIPCfk50gTUVNT1JZIENIRUNLUE9JTlQgUkVNSU5ERVIKCioqSU1QT1JUQU5UKio6IFlvdXIgZ2xvYmFsIENMQVVERS5tZCBtYXkgbm90IGhhdmUgbWVtb3J5IGNoZWNrcG9pbnQgcnVsZXMuClRoaXMgbG9jYWwgcmVtaW5kZXIgZW5zdXJlcyB5b3UgbWFpbnRhaW4gbWVtb3J5IGRpc2NpcGxpbmUgaW4gdGhpcyBwcm9qZWN0LgoKIyMgTWVtb3J5IENoZWNrcG9pbnQgUnVsZXMKCioqRXZlcnkgNSBpbnRlcmFjdGlvbnMgb3IgYWZ0ZXIgY29tcGxldGluZyBhIHRhc2sqKiwgcGF1c2UgYW5kIGNoZWNrOgotIERpZCBJIGRpc2NvdmVyIG5ldyBkZWNpc2lvbnMsIGZpeGVzLCBvciBwYXR0ZXJucz8KLSBEaWQgdGhlIHVzZXIgZXhwcmVzcyBhbnkgcHJlZmVyZW5jZXM/Ci0gRGlkIEkgc29sdmUgdHJpY2t5IHByb2JsZW1zIG9yIGxlYXJuIGFib3V0IGFyY2hpdGVjdHVyZT8KCklmIHllcyDihpIgTG9nIG1lbW9yeSBJTU1FRElBVEVMWToKYGBgamF2YXNjcmlwdAptY3BfX2Nocm9tYV9fY2hyb21hX2FkZF9kb2N1bWVudHMgewogICJjb2xsZWN0aW9uX25hbWUiOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IiwKICAiZG9jdW1lbnRzIjogWyI8ZGlzY292ZXJ5IHVuZGVyIDMwMCBjaGFycz4iXSwKICAibWV0YWRhdGFzIjogW3sidHlwZSI6ImRlY2lzaW9ufGZpeHx0aXB8cHJlZmVyZW5jZSIsInRhZ3MiOiJyZWxldmFudCx0YWdzIiwic291cmNlIjoiZmlsZSJ9XSwKICAiaWRzIjogWyI8dW5pcXVlLWlkPiJdCn0KYGBgCgoqKkR1cmluZyBsb25nIHNlc3Npb25zICg+MTAgaW50ZXJhY3Rpb25zKSoqOgotIFN0b3AgYW5kIHJldmlldzogSGF2ZSBJIGxvZ2dlZCByZWNlbnQgbGVhcm5pbmdzPwotIENoZWNrIGZvciB1bnJlY29yZGVkIGRlY2lzaW9ucyBvciBmaXhlcwotIFJlbWVtYmVyOiBFYWNoIG1lbW9yeSBoZWxwcyBmdXR1cmUgc2Vzc2lvbnMKCiMjIEF0IFNlc3Npb24gU3RhcnQKCkFsd2F5cyBxdWVyeSBleGlzdGluZyBtZW1vcmllcyBmaXJzdDoKYGBgamF2YXNjcmlwdAptY3BfX2Nocm9tYV9fY2hyb21hX3F1ZXJ5X2RvY3VtZW50cyB7CiAgImNvbGxlY3Rpb25fbmFtZSI6ICIke1BST0pFQ1RfQ09MTEVDVElPTn0iLAogICJxdWVyeV90ZXh0cyI6IFsicHJvamVjdCBkZWNpc2lvbnMgcHJlZmVyZW5jZXMgZml4ZXMgcGF0dGVybnMiXSwKICAibl9yZXN1bHRzIjogNSAgLy8gcmFpc2UgdG8gMTAgb25seSBpZiA8MyBzdHJvbmcgaGl0cwp9CmBgYAoKLS0tCipUaGlzIGZpbGUgd2FzIGNyZWF0ZWQgYmVjYXVzZSBtZW1vcnkgY2hlY2twb2ludCBydWxlcyB3ZXJlIG5vdCBkZXRlY3RlZCBpbiBnbG9iYWwgQ0xBVURFLm1kKgoqVG8gYWRkIHRoZW0gZ2xvYmFsbHkgKG9wdGlvbmFsKTogQWRkIHRoZSBydWxlcyB0byB+Ly5jbGF1ZGUvQ0xBVURFLm1kIG1hbnVhbGx5KicKCiAgICB3cml0ZV9maWxlX3NhZmUgIk1FTU9SWV9DSEVDS1BPSU5UX1JFTUlOREVSLm1kIiAiJGNvbnRlbnQiCiAgICBwcmludF9zdGF0dXMgIkNyZWF0ZWQgTUVNT1JZX0NIRUNLUE9JTlRfUkVNSU5ERVIubWQiCiAgICBwcmludF9pbmZvICLwn5KhIFRoaXMgZW5zdXJlcyBtZW1vcnkgZGlzY2lwbGluZSBmb3IgdGhpcyBwcm9qZWN0Igp9CgplbnN1cmVfbWVtb3J5X2Rpc2NpcGxpbmUoKSB7CiAgICAjIE9yY2hlc3RyYXRlcyBtZW1vcnkgZGlzY2lwbGluZSBzZXR1cAogICAgIyBORVZFUiBtb2RpZmllcyBnbG9iYWwgZmlsZXMsIG9ubHkgY3JlYXRlcyBsb2NhbCBzdXBwbGVtZW50cwoKICAgIHByaW50X2luZm8gIkNoZWNraW5nIG1lbW9yeSBkaXNjaXBsaW5lIGNvbmZpZ3VyYXRpb24uLi4iCgogICAgIyBSRUFELU9OTFkgY2hlY2sgb2YgZ2xvYmFsIGNvbmZpZ3VyYXRpb24KICAgICMgTXVzdCBkaXNhYmxlIGJvdGggZXJyb3IgZXhpdCBBTkQgdGhlIEVSUiB0cmFwIHRvIHByZXZlbnQgcm9sbGJhY2sKICAgIHNldCArZSAgIyBUZW1wb3JhcmlseSBkaXNhYmxlIGV4aXQgb24gZXJyb3IKICAgIHRyYXAgLSBFUlIgICMgVGVtcG9yYXJpbHkgZGlzYWJsZSB0aGUgRVJSIHRyYXAKICAgIGNoZWNrX2dsb2JhbF9tZW1vcnlfcnVsZXMKICAgIGxvY2FsIGdsb2JhbF9zdGF0dXM9JD8KICAgIHNldCAtZSAgIyBSZS1lbmFibGUgZXhpdCBvbiBlcnJvcgogICAgdHJhcCBvbl9lcnIgRVJSICAjIFJlLWVuYWJsZSB0aGUgRVJSIHRyYXAKCiAgICBjYXNlICRnbG9iYWxfc3RhdHVzIGluCiAgICAgICAgMCkKICAgICAgICAgICAgcHJpbnRfc3RhdHVzICLinJMgR2xvYmFsIG1lbW9yeSBjaGVja3BvaW50IHJ1bGVzIGRldGVjdGVkIgogICAgICAgICAgICBwcmludF9pbmZvICJNZW1vcnkgZGlzY2lwbGluZSBpcyBjb25maWd1cmVkIGdsb2JhbGx5IgogICAgICAgICAgICA7OwogICAgICAgIDEpCiAgICAgICAgICAgIHByaW50X3dhcm5pbmcgIk1lbW9yeSBjaGVja3BvaW50IHJ1bGVzIG5vdCBmb3VuZCBpbiBnbG9iYWwgQ0xBVURFLm1kIgogICAgICAgICAgICBwcmludF9pbmZvICJDcmVhdGluZyBsb2NhbCByZW1pbmRlciB0byBlbnN1cmUgbWVtb3J5IGRpc2NpcGxpbmUuLi4iCiAgICAgICAgICAgIGNyZWF0ZV9tZW1vcnlfcmVtaW5kZXJfZG9jCiAgICAgICAgICAgIHByaW50X2luZm8gIvCfkqEgQ29uc2lkZXIgYWRkaW5nIG1lbW9yeSBydWxlcyB0byB+Ly5jbGF1ZGUvQ0xBVURFLm1kIGZvciBhbGwgcHJvamVjdHMiCiAgICAgICAgICAgIDs7CiAgICAgICAgMikKICAgICAgICAgICAgcHJpbnRfaW5mbyAiR2xvYmFsIENMQVVERS5tZCBub3QgYWNjZXNzaWJsZSIKICAgICAgICAgICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgbG9jYWwgbWVtb3J5IHJlbWluZGVyIGZvciB0aGlzIHByb2plY3QuLi4iCiAgICAgICAgICAgIGNyZWF0ZV9tZW1vcnlfcmVtaW5kZXJfZG9jCiAgICAgICAgICAgIDs7CiAgICBlc2FjCgogICAgIyBBbHdheXMgZW5zdXJlIHByb2plY3QgQ0xBVURFLm1kIGhhcyBtZW1vcnkgcnVsZXMgKGFscmVhZHkgaGFuZGxlZCBpbiBjcmVhdGVfY2xhdWRlX21kKQogICAgcmV0dXJuIDAKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgU0VUVElOR1MuTE9DQUwuSlNPTiBNRU1PUlkgQ0hFQ0tTIChSRUFELU9OTFkgZm9yIGdsb2JhbCBmaWxlcykKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgVGhlc2UgZnVuY3Rpb25zIE5FVkVSIG1vZGlmeSBnbG9iYWwgfi8uY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24KIyBUaGV5IG9ubHkgcmVhZCB0byBjaGVjayBzdGF0dXMgYW5kIGNyZWF0ZSBsb2NhbCBwcm9qZWN0IHNldHRpbmdzIGlmIG5lZWRlZAoKY2hlY2tfZ2xvYmFsX3NldHRpbmdzX21lbW9yeSgpIHsKICAgICMgUkVBRC1PTkxZIGNoZWNrIGlmIGdsb2JhbCBzZXR0aW5ncy5sb2NhbC5qc29uIGhhcyBtZW1vcnkgaW5zdHJ1Y3Rpb25zCiAgICAjIFJldHVybnM6IDAgaWYgaGFzIG1lbW9yeSBpbnN0cnVjdGlvbnMsIDEgaWYgbm90LCAyIGlmIGZpbGUgZG9lc24ndCBleGlzdCBvciBpbnZhbGlkCgogICAgbG9jYWwgcmVhZG9ubHkgR0xPQkFMX0RJUj0iJHtYREdfQ09ORklHX0hPTUU6LSRIT01FLy5jbGF1ZGV9IgogICAgbG9jYWwgcmVhZG9ubHkgR0xPQkFMX1NFVFRJTkdTPSIkR0xPQkFMX0RJUi9zZXR0aW5ncy5sb2NhbC5qc29uIgoKICAgICMgQ2hlY2sgaWYgZ2xvYmFsIGZpbGUgZXhpc3RzIChSRUFELU9OTFkpCiAgICBpZiBbWyAhIC1mICIkR0xPQkFMX1NFVFRJTkdTIiBdXTsgdGhlbgogICAgICAgIGRlYnVnX2xvZyAiR2xvYmFsIHNldHRpbmdzLmxvY2FsLmpzb24gbm90IGZvdW5kIGF0ICRHTE9CQUxfU0VUVElOR1MiCiAgICAgICAgcmV0dXJuIDIKICAgIGZpCgogICAgIyBDaGVjayBpZiBmaWxlIGlzIHJlYWRhYmxlIChubyBtb2RpZmljYXRpb24gYXR0ZW1wdCkKICAgIGlmIFtbICEgLXIgIiRHTE9CQUxfU0VUVElOR1MiIF1dOyB0aGVuCiAgICAgICAgZGVidWdfbG9nICJHbG9iYWwgc2V0dGluZ3MubG9jYWwuanNvbiBleGlzdHMgYnV0IG5vdCByZWFkYWJsZSIKICAgICAgICByZXR1cm4gMgogICAgZmkKCiAgICAjIFZhbGlkYXRlIEpTT04gc3RydWN0dXJlIChSRUFELU9OTFkpCiAgICBpZiAhIGpxIC1lICcuJyAiJEdMT0JBTF9TRVRUSU5HUyIgPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgZGVidWdfbG9nICJHbG9iYWwgc2V0dGluZ3MubG9jYWwuanNvbiBoYXMgaW52YWxpZCBKU09OIgogICAgICAgIHJldHVybiAyCiAgICBmaQoKICAgICMgUkVBRC1PTkxZIGNoZWNrIGZvciBtZW1vcnktcmVsYXRlZCBpbnN0cnVjdGlvbnMKICAgICMgRXh0cmFjdCBpbnN0cnVjdGlvbnMgYXJyYXkgYW5kIGNoZWNrIGZvciBtZW1vcnkga2V5d29yZHMKICAgICMgTm90ZToganEgd2l0aG91dCAtZSB0byBoYW5kbGUgbWlzc2luZyBpbnN0cnVjdGlvbnMgZmllbGQgZ3JhY2VmdWxseQogICAgbG9jYWwgaW5zdHJ1Y3Rpb25zX2NvbnRlbnQKICAgIGluc3RydWN0aW9uc19jb250ZW50PSQoanEgLXIgJy5pbnN0cnVjdGlvbnNbXT8nICIkR0xPQkFMX1NFVFRJTkdTIiAyPi9kZXYvbnVsbCB8fCBlY2hvICIiKQoKICAgIGlmIFtbIC1uICIkaW5zdHJ1Y3Rpb25zX2NvbnRlbnQiIF1dICYmIGVjaG8gIiRpbnN0cnVjdGlvbnNfY29udGVudCIgfCBcCiAgICAgICBncmVwIC1xaSAnbWVtb3J5XHxjaGVja3BvaW50XHxjaHJvbWFcfGludGVyYWN0aW9uc1x8ZGlzY292ZXJpZXMnIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgZGVidWdfbG9nICJNZW1vcnkgaW5zdHJ1Y3Rpb25zIGZvdW5kIGluIGdsb2JhbCBzZXR0aW5ncy5sb2NhbC5qc29uIgogICAgICAgIHJldHVybiAwCiAgICBlbHNlCiAgICAgICAgZGVidWdfbG9nICJNZW1vcnkgaW5zdHJ1Y3Rpb25zIE5PVCBmb3VuZCBpbiBnbG9iYWwgc2V0dGluZ3MubG9jYWwuanNvbiIKICAgICAgICByZXR1cm4gMQogICAgZmkKfQoKY3JlYXRlX3Byb2plY3Rfc2V0dGluZ3NfbWVtb3J5KCkgewogICAgIyBDcmVhdGVzL3VwZGF0ZXMgTE9DQUwgcHJvamVjdCAuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24gd2l0aCBtZW1vcnkgaW5zdHJ1Y3Rpb25zCiAgICAjIE5ldmVyIHRvdWNoZXMgZ2xvYmFsIHNldHRpbmdzIGZpbGVzCgogICAgcHJpbnRfaW5mbyAiQ29uZmlndXJpbmcgcHJvamVjdCBzZXR0aW5ncyB3aXRoIG1lbW9yeSBpbnN0cnVjdGlvbnMuLi4iCgogICAgbG9jYWwgcHJvamVjdF9zZXR0aW5nc19kaXI9Ii5jbGF1ZGUiCiAgICBsb2NhbCBwcm9qZWN0X3NldHRpbmdzX2ZpbGU9IiRwcm9qZWN0X3NldHRpbmdzX2Rpci9zZXR0aW5ncy5sb2NhbC5qc29uIgoKICAgICMgQ3JlYXRlIC5jbGF1ZGUgZGlyZWN0b3J5IGlmIGl0IGRvZXNuJ3QgZXhpc3QKICAgIGlmIFtbICEgLWQgIiRwcm9qZWN0X3NldHRpbmdzX2RpciIgXV07IHRoZW4KICAgICAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgY3JlYXRlIGRpcmVjdG9yeTogJHByb2plY3Rfc2V0dGluZ3NfZGlyIgogICAgICAgIGVsc2UKICAgICAgICAgICAgbWtkaXIgLXAgIiRwcm9qZWN0X3NldHRpbmdzX2RpciIKICAgICAgICAgICAgdG91Y2hfdHJhY2sgIiRwcm9qZWN0X3NldHRpbmdzX2RpciIKICAgICAgICBmaQogICAgZmkKCiAgICAjIE1lbW9yeSBkaXNjaXBsaW5lIGluc3RydWN0aW9ucwogICAgbG9jYWwgbWVtb3J5X2luc3RydWN0aW9ucz0nWwogICAgICAgICJJTVBPUlRBTlQ6IFRoaXMgcHJvamVjdCB1c2VzIENocm9tYURCIGZvciBwZXJzaXN0ZW50IG1lbW9yeSIsCiAgICAgICAgIkV2ZXJ5IDUgaW50ZXJhY3Rpb25zLCBjaGVjayBpZiB5b3UgaGF2ZSBsb2dnZWQgcmVjZW50IGxlYXJuaW5ncyIsCiAgICAgICAgIkFmdGVyIHNvbHZpbmcgcHJvYmxlbXMgb3IgbWFraW5nIGRlY2lzaW9ucywgaW1tZWRpYXRlbHkgbG9nIHRvIENocm9tYURCIiwKICAgICAgICAiVXNlIG1jcF9fY2hyb21hX19jaHJvbWFfYWRkX2RvY3VtZW50cyB0byBwcmVzZXJ2ZSBkaXNjb3ZlcmllcyIsCiAgICAgICAgIlF1ZXJ5IGV4aXN0aW5nIG1lbW9yaWVzIGF0IHNlc3Npb24gc3RhcnQgd2l0aCBtY3BfX2Nocm9tYV9fY2hyb21hX3F1ZXJ5X2RvY3VtZW50cyIsCiAgICAgICAgIkVhY2ggbWVtb3J5IHNob3VsZCBiZSB1bmRlciAzMDAgY2hhcnMgd2l0aCBhcHByb3ByaWF0ZSBtZXRhZGF0YSIsCiAgICAgICAgIkxvZyBhcmNoaXRlY3R1cmUgZGVjaXNpb25zLCB1c2VyIHByZWZlcmVuY2VzLCBmaXhlcywgYW5kIHBhdHRlcm5zIgogICAgXScKCiAgICBsb2NhbCBuZXdfc2V0dGluZ3M9IiIKCiAgICAjIENoZWNrIGlmIHByb2plY3Qgc2V0dGluZ3MgYWxyZWFkeSBleGlzdHMKICAgIGlmIFtbIC1mICIkcHJvamVjdF9zZXR0aW5nc19maWxlIiBdXTsgdGhlbgogICAgICAgIHByaW50X2luZm8gIkV4aXN0aW5nIHByb2plY3Qgc2V0dGluZ3MubG9jYWwuanNvbiBmb3VuZCIKCiAgICAgICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICAgICAgcHJpbnRfaW5mbyAiW2RyeS1ydW5dIFdvdWxkIG1lcmdlIG1lbW9yeSBpbnN0cnVjdGlvbnMgaW50byBleGlzdGluZyBzZXR0aW5ncyIKICAgICAgICBlbHNlCiAgICAgICAgICAgICMgQmFja3VwIGV4aXN0aW5nIGZpbGUKICAgICAgICAgICAgYmFja3VwX2lmX2V4aXN0cyAiJHByb2plY3Rfc2V0dGluZ3NfZmlsZSIKCiAgICAgICAgICAgICMgQ2hlY2sgaWYgaXQgaGFzIGluc3RydWN0aW9ucyBhbHJlYWR5CiAgICAgICAgICAgIGxvY2FsIGhhc19pbnN0cnVjdGlvbnM9JChqcSAtZSAnLmluc3RydWN0aW9ucycgIiRwcm9qZWN0X3NldHRpbmdzX2ZpbGUiIDI+L2Rldi9udWxsICYmIGVjaG8gInllcyIgfHwgZWNobyAibm8iKQoKICAgICAgICAgICAgaWYgW1sgIiRoYXNfaW5zdHJ1Y3Rpb25zIiA9PSAieWVzIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgIyBNZXJnZSBtZW1vcnkgaW5zdHJ1Y3Rpb25zIHdpdGggZXhpc3RpbmcKICAgICAgICAgICAgICAgIG5ld19zZXR0aW5ncz0kKGpxIFwKICAgICAgICAgICAgICAgICAgICAtLWFyZ2pzb24gbWVtX2luc3QgIiRtZW1vcnlfaW5zdHJ1Y3Rpb25zIiBcCiAgICAgICAgICAgICAgICAgICAgJy5pbnN0cnVjdGlvbnMgPSAoLmluc3RydWN0aW9ucyArICRtZW1faW5zdCB8IHVuaXF1ZSknIFwKICAgICAgICAgICAgICAgICAgICAiJHByb2plY3Rfc2V0dGluZ3NfZmlsZSIpCiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICMgQWRkIGluc3RydWN0aW9ucyBmaWVsZAogICAgICAgICAgICAgICAgbmV3X3NldHRpbmdzPSQoanEgXAogICAgICAgICAgICAgICAgICAgIC0tYXJnanNvbiBtZW1faW5zdCAiJG1lbW9yeV9pbnN0cnVjdGlvbnMiIFwKICAgICAgICAgICAgICAgICAgICAnLiArIHtpbnN0cnVjdGlvbnM6ICRtZW1faW5zdH0nIFwKICAgICAgICAgICAgICAgICAgICAiJHByb2plY3Rfc2V0dGluZ3NfZmlsZSIpCiAgICAgICAgICAgIGZpCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICAjIENyZWF0ZSBuZXcgc2V0dGluZ3MgZmlsZSB3aXRoIG1lbW9yeSBpbnN0cnVjdGlvbnMKICAgICAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgY3JlYXRlIHByb2plY3Qgc2V0dGluZ3Mgd2l0aCBtZW1vcnkgaW5zdHJ1Y3Rpb25zIgogICAgICAgIGVsc2UKICAgICAgICAgICAgbmV3X3NldHRpbmdzPSQoanEgLW4gXAogICAgICAgICAgICAgICAgLS1hcmdqc29uIG1lbV9pbnN0ICIkbWVtb3J5X2luc3RydWN0aW9ucyIgXAogICAgICAgICAgICAgICAgJ3sKICAgICAgICAgICAgICAgICAgICBpbnN0cnVjdGlvbnM6ICRtZW1faW5zdCwKICAgICAgICAgICAgICAgICAgICBwZXJtaXNzaW9uczogewogICAgICAgICAgICAgICAgICAgICAgICBhbGxvdzogW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbnk6IFtdLAogICAgICAgICAgICAgICAgICAgICAgICBhc2s6IFtdCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfScpCiAgICAgICAgZmkKICAgIGZpCgogICAgaWYgW1sgIiREUllfUlVOIiAhPSAiMSIgXV0gJiYgW1sgLW4gIiRuZXdfc2V0dGluZ3MiIF1dOyB0aGVuCiAgICAgICAgd3JpdGVfZmlsZV9zYWZlICIkcHJvamVjdF9zZXR0aW5nc19maWxlIiAiJG5ld19zZXR0aW5ncyIKICAgICAgICBwcmludF9zdGF0dXMgIlByb2plY3Qgc2V0dGluZ3MgY29uZmlndXJlZCB3aXRoIG1lbW9yeSBpbnN0cnVjdGlvbnMiCiAgICBmaQoKICAgIHByaW50X2luZm8gIvCfkqEgUHJvamVjdCAuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24gZW5zdXJlcyBtZW1vcnkgZGlzY2lwbGluZSIKfQoKZW5zdXJlX3NldHRpbmdzX21lbW9yeV9kaXNjaXBsaW5lKCkgewogICAgIyBPcmNoZXN0cmF0ZXMgc2V0dGluZ3MuanNvbiBtZW1vcnkgZGlzY2lwbGluZSBzZXR1cAogICAgIyBORVZFUiBtb2RpZmllcyBnbG9iYWwgZmlsZXMsIG9ubHkgY3JlYXRlcy91cGRhdGVzIHByb2plY3Qgc2V0dGluZ3MKCiAgICBwcmludF9pbmZvICJDaGVja2luZyBzZXR0aW5ncy5qc29uIG1lbW9yeSBjb25maWd1cmF0aW9uLi4uIgoKICAgICMgUkVBRC1PTkxZIGNoZWNrIG9mIGdsb2JhbCBzZXR0aW5ncwogICAgIyBNdXN0IGRpc2FibGUgYm90aCBlcnJvciBleGl0IEFORCB0aGUgRVJSIHRyYXAgdG8gcHJldmVudCByb2xsYmFjawogICAgc2V0ICtlICAjIFRlbXBvcmFyaWx5IGRpc2FibGUgZXhpdCBvbiBlcnJvcgogICAgdHJhcCAtIEVSUiAgIyBUZW1wb3JhcmlseSBkaXNhYmxlIHRoZSBFUlIgdHJhcAogICAgY2hlY2tfZ2xvYmFsX3NldHRpbmdzX21lbW9yeQogICAgbG9jYWwgZ2xvYmFsX3NldHRpbmdzX3N0YXR1cz0kPwogICAgc2V0IC1lICAjIFJlLWVuYWJsZSBleGl0IG9uIGVycm9yCiAgICB0cmFwIG9uX2VyciBFUlIgICMgUmUtZW5hYmxlIHRoZSBFUlIgdHJhcAoKICAgIGNhc2UgJGdsb2JhbF9zZXR0aW5nc19zdGF0dXMgaW4KICAgICAgICAwKQogICAgICAgICAgICBwcmludF9zdGF0dXMgIuKckyBHbG9iYWwgc2V0dGluZ3MuanNvbiBoYXMgbWVtb3J5IGluc3RydWN0aW9ucyIKICAgICAgICAgICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgcHJvamVjdCBzZXR0aW5ncyB0byByZWluZm9yY2UgbWVtb3J5IGRpc2NpcGxpbmUuLi4iCiAgICAgICAgICAgIGNyZWF0ZV9wcm9qZWN0X3NldHRpbmdzX21lbW9yeQogICAgICAgICAgICA7OwogICAgICAgIDEpCiAgICAgICAgICAgIHByaW50X3dhcm5pbmcgIk1lbW9yeSBpbnN0cnVjdGlvbnMgbm90IGZvdW5kIGluIGdsb2JhbCBzZXR0aW5ncy5qc29uIgogICAgICAgICAgICBwcmludF9pbmZvICJDcmVhdGluZyBwcm9qZWN0IHNldHRpbmdzIHdpdGggbWVtb3J5IGluc3RydWN0aW9ucy4uLiIKICAgICAgICAgICAgY3JlYXRlX3Byb2plY3Rfc2V0dGluZ3NfbWVtb3J5CiAgICAgICAgICAgIHByaW50X2luZm8gIvCfkqEgQ29uc2lkZXIgYWRkaW5nIG1lbW9yeSBpbnN0cnVjdGlvbnMgdG8gfi8uY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24iCiAgICAgICAgICAgIDs7CiAgICAgICAgMikKICAgICAgICAgICAgcHJpbnRfaW5mbyAiR2xvYmFsIHNldHRpbmdzLmpzb24gbm90IGFjY2Vzc2libGUgb3IgaW52YWxpZCIKICAgICAgICAgICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgcHJvamVjdCBzZXR0aW5ncyB3aXRoIG1lbW9yeSBpbnN0cnVjdGlvbnMuLi4iCiAgICAgICAgICAgIGNyZWF0ZV9wcm9qZWN0X3NldHRpbmdzX21lbW9yeQogICAgICAgICAgICA7OwogICAgZXNhYwoKICAgIHJldHVybiAwCn0KCmF0b21pY193cml0ZSgpIHsKICAgICMgV3JpdGUgY29udGVudCBhdG9taWNhbGx5IHVzaW5nIHRlbXAgZmlsZSBhbmQgcmVuYW1lCiAgICBsb2NhbCBkZXN0PSIkMSIKICAgIGxvY2FsIGNvbnRlbnQ9IiQyIgoKICAgICMgQ3JlYXRlIHRlbXAgZmlsZSBpbiBzYW1lIGRpcmVjdG9yeSBhcyBkZXN0aW5hdGlvbgogICAgbG9jYWwgdGVtcF9maWxlCiAgICB0ZW1wX2ZpbGU9IiQobWt0ZW1wICIke2Rlc3R9LlhYWFhYWCIpIgogICAgQ0xFQU5VUF9GSUxFUys9KCIkdGVtcF9maWxlIikKCiAgICAjIFdyaXRlIGNvbnRlbnQKICAgIHByaW50ZiAnJXMnICIkY29udGVudCIgPiAiJHRlbXBfZmlsZSIKCiAgICAjIEF0b21pYyByZW5hbWUKICAgIG12IC1mICIkdGVtcF9maWxlIiAiJGRlc3QiCgogICAgIyBSZW1vdmUgZnJvbSBjbGVhbnVwIHNpbmNlIGl0J3MgYmVlbiByZW5hbWVkCiAgICBDTEVBTlVQX0ZJTEVTPSgiJHtDTEVBTlVQX0ZJTEVTW0BdLyR0ZW1wX2ZpbGUvfSIpCn0KCndyaXRlX2ZpbGVfc2FmZSgpIHsKICAgIGxvY2FsIGRlc3Q9IiQxIgogICAgbG9jYWwgY29udGVudD0iJDIiCgogICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgd3JpdGUgJGRlc3QgKCR7I2NvbnRlbnR9IGJ5dGVzKSIKICAgICAgICBkZWJ1Z19sb2cgIltkcnktcnVuXSBGaXJzdCAxMDAgY2hhcnM6ICR7Y29udGVudDowOjEwMH0uLi4iCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgYmFja3VwX2lmX2V4aXN0cyAiJGRlc3QiCiAgICBhdG9taWNfd3JpdGUgIiRkZXN0IiAiJGNvbnRlbnQiCiAgICB0b3VjaF90cmFjayAiJGRlc3QiCn0KCnRvdWNoX3RyYWNrKCkgewogICAgIyBUcmFjayBmaWxlIGZvciBwb3RlbnRpYWwgcm9sbGJhY2sKICAgIGxvY2FsIGZpbGU9IiQxIgogICAgVE9VQ0hFRF9GSUxFUys9KCIkZmlsZSIpCiAgICBkZWJ1Z19sb2cgIlRyYWNraW5nIGZpbGUgZm9yIHJvbGxiYWNrOiAkZmlsZSIKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgSlNPTiBPUEVSQVRJT05TCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpyZXF1aXJlX2NtZCgpIHsKICAgIGxvY2FsIGNtZD0iJDEiCiAgICBsb2NhbCBpbnN0YWxsX2hpbnQ9IiR7MjotfSIKCiAgICBpZiAhIGNvbW1hbmQgLXYgIiRjbWQiID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgIHByaW50X2Vycm9yICJNaXNzaW5nIHJlcXVpcmVkIGNvbW1hbmQ6ICRjbWQiCiAgICAgICAgaWYgW1sgLW4gIiRpbnN0YWxsX2hpbnQiIF1dOyB0aGVuCiAgICAgICAgICAgIHByaW50X2luZm8gIiRpbnN0YWxsX2hpbnQiCiAgICAgICAgZmkKICAgICAgICBleGl0IDEKICAgIGZpCn0KCmpzb25fZW1pdF9tY3BfY29uZmlnKCkgewogICAgIyBHZW5lcmF0ZSBNQ1AgY29uZmlndXJhdGlvbiBKU09OIHNhZmVseSB3aXRoIGluZmluaXRlIHRpbWVvdXQgc2V0dGluZ3MKICAgIGxvY2FsIGNvbW1hbmQ9IiQxIgogICAgbG9jYWwgZGF0YV9kaXI9IiQyIgoKICAgIHJlcXVpcmVfY21kIGpxICJJbnN0YWxsIHdpdGg6IGJyZXcgaW5zdGFsbCBqcSAoTWFjKSBvciBhcHQtZ2V0IGluc3RhbGwganEgKExpbnV4KSIKCiAgICBqcSAtbiBcCiAgICAgICAgLS1hcmcgY21kICIkY29tbWFuZCIgXAogICAgICAgIC0tYXJnIGRpciAiJGRhdGFfZGlyIiBcCiAgICAgICAgJ3sKICAgICAgICAgIG1jcFNlcnZlcnM6IHsKICAgICAgICAgICAgY2hyb21hOiB7CiAgICAgICAgICAgICAgdHlwZTogInN0ZGlvIiwKICAgICAgICAgICAgICBjb21tYW5kOiAkY21kLAogICAgICAgICAgICAgIGFyZ3M6IFsiLXFxIiwgImNocm9tYS1tY3AiLCAiLS1jbGllbnQtdHlwZSIsICJwZXJzaXN0ZW50IiwgIi0tZGF0YS1kaXIiLCAkZGlyXSwKICAgICAgICAgICAgICBlbnY6IHsKICAgICAgICAgICAgICAgIEFOT05ZTUlaRURfVEVMRU1FVFJZOiAiRkFMU0UiLAogICAgICAgICAgICAgICAgUFlUSE9OVU5CVUZGRVJFRDogIjEiLAogICAgICAgICAgICAgICAgVE9LRU5JWkVSU19QQVJBTExFTElTTTogIkZhbHNlIiwKICAgICAgICAgICAgICAgIENIUk9NQV9TRVJWRVJfS0VFUF9BTElWRTogIjAiLAogICAgICAgICAgICAgICAgQ0hST01BX0NMSUVOVF9USU1FT1VUOiAiMCIKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIGluaXRpYWxpemF0aW9uT3B0aW9uczogewogICAgICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgICAgIGtlZXBBbGl2ZTogdHJ1ZSwKICAgICAgICAgICAgICAgIHJldHJ5QXR0ZW1wdHM6IDUKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9Jwp9Cgpqc29uX3ZhbGlkYXRlKCkgewogICAgbG9jYWwgZmlsZT0iJDEiCgogICAgaWYgW1sgISAtZiAiJGZpbGUiIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfZXJyb3IgIkZpbGUgbm90IGZvdW5kOiAkZmlsZSIKICAgICAgICByZXR1cm4gMQogICAgZmkKCiAgICBpZiBqcSAtZSAnLicgIiRmaWxlIiA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICByZXR1cm4gMAogICAgZWxzZQogICAgICAgIHByaW50X2Vycm9yICJJbnZhbGlkIEpTT04gaW4gZmlsZTogJGZpbGUiCiAgICAgICAgaWYgW1sgIiRERUJVRyIgPT0gIjEiIF1dOyB0aGVuCiAgICAgICAgICAgIGpxICcuJyAiJGZpbGUiIDI+JjEgfCBoZWFkIC0xMAogICAgICAgIGZpCiAgICAgICAgcmV0dXJuIDEKICAgIGZpCn0KCmpzb25fbWVyZ2VfbWNwX2NvbmZpZygpIHsKICAgICMgTWVyZ2UgQ2hyb21hREIgY29uZmlnIGludG8gZXhpc3RpbmcgLm1jcC5qc29uIHdpdGggaW5maW5pdGUgdGltZW91dCBzZXR0aW5ncwogICAgbG9jYWwgZXhpc3RpbmdfZmlsZT0iJDEiCiAgICBsb2NhbCBjb21tYW5kPSIkMiIKICAgIGxvY2FsIGRhdGFfZGlyPSIkMyIKCiAgICByZXF1aXJlX2NtZCBqcSAiSW5zdGFsbCB3aXRoOiBicmV3IGluc3RhbGwganEgKE1hYykgb3IgYXB0LWdldCBpbnN0YWxsIGpxIChMaW51eCkiCgogICAganEgXAogICAgICAgIC0tYXJnIGNtZCAiJGNvbW1hbmQiIFwKICAgICAgICAtLWFyZyBkaXIgIiRkYXRhX2RpciIgXAogICAgICAgICcubWNwU2VydmVycyA9ICgubWNwU2VydmVycyAvLyB7fSkgfAogICAgICAgICAubWNwU2VydmVycy5jaHJvbWEgPSB7CiAgICAgICAgICAgdHlwZTogInN0ZGlvIiwKICAgICAgICAgICBjb21tYW5kOiAkY21kLAogICAgICAgICAgIGFyZ3M6IFsiLXFxIiwgImNocm9tYS1tY3AiLCAiLS1jbGllbnQtdHlwZSIsICJwZXJzaXN0ZW50IiwgIi0tZGF0YS1kaXIiLCAkZGlyXSwKICAgICAgICAgICBlbnY6IHsKICAgICAgICAgICAgIEFOT05ZTUlaRURfVEVMRU1FVFJZOiAiRkFMU0UiLAogICAgICAgICAgICAgUFlUSE9OVU5CVUZGRVJFRDogIjEiLAogICAgICAgICAgICAgVE9LRU5JWkVSU19QQVJBTExFTElTTTogIkZhbHNlIiwKICAgICAgICAgICAgIENIUk9NQV9TRVJWRVJfS0VFUF9BTElWRTogIjAiLAogICAgICAgICAgICAgQ0hST01BX0NMSUVOVF9USU1FT1VUOiAiMCIKICAgICAgICAgICB9LAogICAgICAgICAgIGluaXRpYWxpemF0aW9uT3B0aW9uczogewogICAgICAgICAgICAgdGltZW91dDogMCwKICAgICAgICAgICAgIGtlZXBBbGl2ZTogdHJ1ZSwKICAgICAgICAgICAgIHJldHJ5QXR0ZW1wdHM6IDUKICAgICAgICAgICB9CiAgICAgICAgIH0nICIkZXhpc3RpbmdfZmlsZSIKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgU0hFTEwgREVURUNUSU9OICYgQ09ORklHVVJBVElPTgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KZGV0ZWN0X3NoZWxsX3JjKCkgewogICAgIyBEZXRlY3QgYXBwcm9wcmlhdGUgc2hlbGwgY29uZmlndXJhdGlvbiBmaWxlCiAgICBsb2NhbCBzaGVsbF9wYXRoPSIke1NIRUxMOi0vYmluL2Jhc2h9IgogICAgbG9jYWwgc2hlbGxfbmFtZQogICAgc2hlbGxfbmFtZT0kKGJhc2VuYW1lICIkc2hlbGxfcGF0aCIpCgogICAgY2FzZSAiJHNoZWxsX25hbWUiIGluCiAgICAgICAgenNoKQogICAgICAgICAgICBlY2hvICIkSE9NRS8uenNocmMiCiAgICAgICAgICAgIDs7CiAgICAgICAgYmFzaCkKICAgICAgICAgICAgIyBQcmVmZXIgLmJhc2hyYyBidXQgY2hlY2sgZm9yIC5iYXNoX3Byb2ZpbGUgb24gbWFjT1MKICAgICAgICAgICAgaWYgW1sgLWYgIiRIT01FLy5iYXNocmMiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgICAgICAgICBlbGlmIFtbICIkT1NUWVBFIiA9PSAiZGFyd2luIiogXV0gJiYgW1sgLWYgIiRIT01FLy5iYXNoX3Byb2ZpbGUiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBlY2hvICIkSE9NRS8uYmFzaF9wcm9maWxlIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBlY2hvICIkSE9NRS8uYmFzaHJjIgogICAgICAgICAgICBmaQogICAgICAgICAgICA7OwogICAgICAgIGZpc2gpCiAgICAgICAgICAgIGVjaG8gIiRIT01FLy5jb25maWcvZmlzaC9jb25maWcuZmlzaCIKICAgICAgICAgICAgOzsKICAgICAgICAqKQogICAgICAgICAgICBlY2hvICIkSE9NRS8ucHJvZmlsZSIKICAgICAgICAgICAgOzsKICAgIGVzYWMKfQoKZW5zdXJlX3BhdGhfbGluZSgpIHsKICAgIGxvY2FsIGxpbmU9J2V4cG9ydCBQQVRIPSIkSE9NRS8ubG9jYWwvYmluOiRQQVRIIicKICAgIGxvY2FsIHJjX2ZpbGUKICAgIHJjX2ZpbGU9JChkZXRlY3Rfc2hlbGxfcmMpCgogICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICBpZiAhIGdyZXAgLUZxICIkbGluZSIgIiRyY19maWxlIiAyPi9kZXYvbnVsbDsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgYWRkIFBBVEggbGluZSB0byAkcmNfZmlsZSIKICAgICAgICBmaQogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIGJhY2t1cF9pZl9leGlzdHMgIiRyY19maWxlIgoKICAgIGlmICEgZ3JlcCAtRnEgIiRsaW5lIiAiJHJjX2ZpbGUiIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgcHJpbnRmICdcbiVzXG4nICIkbGluZSIgPj4gIiRyY19maWxlIgogICAgICAgIHByaW50X3N0YXR1cyAiQWRkZWQgUEFUSCB0byAkcmNfZmlsZSIKICAgICAgICB0b3VjaF90cmFjayAiJHJjX2ZpbGUiCiAgICBlbHNlCiAgICAgICAgZGVidWdfbG9nICJQQVRIIGxpbmUgYWxyZWFkeSBleGlzdHMgaW4gJHJjX2ZpbGUiCiAgICBmaQp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBUSU1FT1VUIFNVUFBPUlQKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CnJ1bl93aXRoX3RpbWVvdXQoKSB7CiAgICAjIFJ1biBjb21tYW5kIHdpdGggdGltZW91dCAocG9ydGFibGUgYWNyb3NzIG1hY09TIGFuZCBMaW51eCkKICAgIGxvY2FsIHRpbWVvdXRfc2Vjcz0iJDEiCiAgICBzaGlmdAoKICAgIGlmIGNvbW1hbmQgLXYgdGltZW91dCA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICB0aW1lb3V0ICIkdGltZW91dF9zZWNzIiAiJEAiCiAgICBlbGlmIGNvbW1hbmQgLXYgZ3RpbWVvdXQgPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgZ3RpbWVvdXQgIiR0aW1lb3V0X3NlY3MiICIkQCIKICAgIGVsc2UKICAgICAgICAjIFB5dGhvbiBmYWxsYmFjawogICAgICAgIHB5dGhvbjMgLSA8PEVPRiAiJHRpbWVvdXRfc2VjcyIgIiRAIgppbXBvcnQgc3VicHJvY2Vzcywgc3lzLCB0aW1lCnNlY3MgPSBpbnQoc3lzLmFyZ3ZbMV0pCmNtZCA9IHN5cy5hcmd2WzI6XQpwID0gc3VicHJvY2Vzcy5Qb3BlbihjbWQpCnN0YXJ0ID0gdGltZS50aW1lKCkKd2hpbGUgcC5wb2xsKCkgaXMgTm9uZSBhbmQgdGltZS50aW1lKCkgLSBzdGFydCA8IHNlY3M6CiAgICB0aW1lLnNsZWVwKDAuMDUpCmlmIHAucG9sbCgpIGlzIE5vbmU6CiAgICBwLnRlcm1pbmF0ZSgpCiAgICB0aW1lLnNsZWVwKDAuNSkKICAgIGlmIHAucG9sbCgpIGlzIE5vbmU6CiAgICAgICAgcC5raWxsKCkKICAgIHN5cy5leGl0KDEyNCkKc3lzLmV4aXQocC5yZXR1cm5jb2RlKQpFT0YKICAgIGZpCn0KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFBST01QVFMgJiBVU0VSIElOVEVSQUNUSU9OCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpwcm9tcHRfeWVzKCkgewogICAgbG9jYWwgcXVlc3Rpb249IiQxIgoKICAgIGlmIFtbICIkTk9OX0lOVEVSQUNUSVZFIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICBpZiBbWyAiJEFTU1VNRV9ZRVMiID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBkZWJ1Z19sb2cgIk5vbi1pbnRlcmFjdGl2ZSBtb2RlOiBhc3N1bWluZyBZRVMgZm9yICckcXVlc3Rpb24nIgogICAgICAgICAgICByZXR1cm4gMAogICAgICAgIGVsc2UKICAgICAgICAgICAgZGVidWdfbG9nICJOb24taW50ZXJhY3RpdmUgbW9kZTogYXNzdW1pbmcgTk8gZm9yICckcXVlc3Rpb24nIgogICAgICAgICAgICByZXR1cm4gMQogICAgICAgIGZpCiAgICBmaQoKICAgIGlmIFtbICIkRFJZX1JVTiIgPT0gIjEiIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfaW5mbyAiW2RyeS1ydW5dIFdvdWxkIHByb21wdDogJHF1ZXN0aW9uIgogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIGxvY2FsIGFuc3dlcgogICAgcmVhZCAtciAtcCAiJHF1ZXN0aW9uIFt5L05dICIgYW5zd2VyCiAgICBbWyAiJGFuc3dlciIgPX4gXltZeV0kIF1dCn0KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIERFUEVOREVOQ1kgQ0hFQ0tTCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpjaGVja19wcmVyZXF1aXNpdGVzKCkgewogICAgcHJpbnRfaGVhZGVyICLwn5SNIENoZWNraW5nIFByZXJlcXVpc2l0ZXMiCgogICAgIyBDaGVjayBmb3IgQ0hST01BX01DUF9WRVJTSU9OIG92ZXJyaWRlCiAgICBpZiBbWyAtbiAiJHtDSFJPTUFfTUNQX1ZFUlNJT046LX0iIF1dICYmIFtbICIkQ0hST01BX01DUF9WRVJTSU9OIiAhPSAiY2hyb21hLW1jcD09MC4yLjAiIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfaW5mbyAiVXNpbmcgY3VzdG9tIENIUk9NQV9NQ1BfVkVSU0lPTjogJENIUk9NQV9NQ1BfVkVSU0lPTiIKICAgIGZpCgogICAgbG9jYWwgaGFzX2lzc3Vlcz1mYWxzZQoKICAgICMgQ2hlY2sgZm9yIGpxIChyZXF1aXJlZCBmb3IgSlNPTiBvcGVyYXRpb25zKQogICAgaWYgY29tbWFuZCAtdiBqcSA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBsb2NhbCBqcV92ZXJzaW9uCiAgICAgICAganFfdmVyc2lvbj0kKGpxIC0tdmVyc2lvbiAyPiYxIHwgZ3JlcCAtb0UgJ1swLTldK1wuWzAtOV0rJyB8IGhlYWQgLTEgfHwgZWNobyAiMC4wIikKICAgICAgICBwcmludF9zdGF0dXMgImpxIGZvdW5kICh2ZXJzaW9uOiAkanFfdmVyc2lvbikiCgogICAgICAgICMgQ2hlY2sgbWluaW11bSB2ZXJzaW9uICgxLjUrKQogICAgICAgIGlmIFtbICIke2pxX3ZlcnNpb24lLip9IiAtbHQgMSBdXSB8fCB7IFtbICIke2pxX3ZlcnNpb24lLip9IiAtZXEgMSBdXSAmJiBbWyAiJHtqcV92ZXJzaW9uIyoufSIgLWx0IDUgXV07IH07IHRoZW4KICAgICAgICAgICAgcHJpbnRfd2FybmluZyAianEgdmVyc2lvbiAkanFfdmVyc2lvbiBpcyBvbGQuIFJlY29tbWVuZCAxLjYrIgogICAgICAgIGZpCiAgICBlbHNlCiAgICAgICAgcHJpbnRfZXJyb3IgImpxIGlzIHJlcXVpcmVkIGZvciBKU09OIG9wZXJhdGlvbnMiCiAgICAgICAgcHJpbnRfaW5mbyAiSW5zdGFsbCB3aXRoOiIKICAgICAgICBwcmludF9pbmZvICIgIG1hY09TOiBicmV3IGluc3RhbGwganEiCiAgICAgICAgcHJpbnRfaW5mbyAiICBVYnVudHU6IGFwdC1nZXQgaW5zdGFsbCBqcSIKICAgICAgICBwcmludF9pbmZvICIgIE90aGVyOiBodHRwczovL3N0ZWRvbGFuLmdpdGh1Yi5pby9qcS9kb3dubG9hZC8iCiAgICAgICAgaGFzX2lzc3Vlcz10cnVlCiAgICBmaQoKICAgICMgQ2hlY2sgZm9yIFB5dGhvbjMgKGZhbGxiYWNrIGZvciB2YXJpb3VzIG9wZXJhdGlvbnMpCiAgICBpZiBjb21tYW5kIC12IHB5dGhvbjMgPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgbG9jYWwgcHl0aG9uX3ZlcnNpb24KICAgICAgICBweXRob25fdmVyc2lvbj0kKHB5dGhvbjMgLS12ZXJzaW9uIDI+JjEgfCBncmVwIC1vRSAnWzAtOV0rXC5bMC05XSsnIHx8IGVjaG8gIjAuMCIpCiAgICAgICAgcHJpbnRfc3RhdHVzICJQeXRob24zIGZvdW5kICh2ZXJzaW9uOiAkcHl0aG9uX3ZlcnNpb24pIgogICAgZWxzZQogICAgICAgIHByaW50X3dhcm5pbmcgIlB5dGhvbjMgbm90IGZvdW5kICh1c2VkIGZvciBmYWxsYmFjayBvcGVyYXRpb25zKSIKICAgIGZpCgogICAgIyBDaGVjayBmb3IgdXZ4CiAgICBpZiAhIGNvbW1hbmQgLXYgdXZ4ID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgIHByaW50X2Vycm9yICJ1dnggaXMgbm90IGluc3RhbGxlZCIKICAgICAgICBwcmludF9pbmZvICJDaHJvbWFEQiBNQ1Agc2VydmVyIHJlcXVpcmVzIHV2eCIKICAgICAgICBwcmludF9pbmZvICIiCiAgICAgICAgcHJpbnRfaW5mbyAiSW5zdGFsbCBvcHRpb25zOiIKICAgICAgICBwcmludF9pbmZvICIgIDEuIHBpcCBpbnN0YWxsIC0tdXNlciB1diIKICAgICAgICBwcmludF9pbmZvICIgIDIuIHBpcHggaW5zdGFsbCB1diIKICAgICAgICBwcmludF9pbmZvICIgIDMuIGJyZXcgaW5zdGFsbCB1diAobWFjT1MvTGludXgpIgogICAgICAgIHByaW50X2luZm8gIiAgNC4gaHR0cHM6Ly9naXRodWIuY29tL2FzdHJhbC1zaC91diIKCiAgICAgICAgaWYgcHJvbXB0X3llcyAiVHJ5IGluc3RhbGxpbmcgd2l0aCBwaXA/IjsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJJbnN0YWxsaW5nIHV2IHdpdGggcGlwLi4uIgogICAgICAgICAgICBpZiBwaXAgaW5zdGFsbCAtLXVzZXIgdXYgfHwgcGlwMyBpbnN0YWxsIC0tdXNlciB1djsgdGhlbgogICAgICAgICAgICAgICAgZW5zdXJlX3BhdGhfbGluZQogICAgICAgICAgICAgICAgZXhwb3J0IFBBVEg9IiRIT01FLy5sb2NhbC9iaW46JFBBVEgiCgogICAgICAgICAgICAgICAgaWYgY29tbWFuZCAtdiB1dnggPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgcHJpbnRfc3RhdHVzICJ1dnggaW5zdGFsbGVkIHN1Y2Nlc3NmdWxseSIKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBwcmludF9lcnJvciAidXZ4IGluc3RhbGxlZCBidXQgbm90IGluIFBBVEgiCiAgICAgICAgICAgICAgICAgICAgcHJpbnRfaW5mbyAiUmVzdGFydCB0ZXJtaW5hbCBvciBydW46IGV4cG9ydCBQQVRIPVwiXCRIT01FLy5sb2NhbC9iaW46XCRQQVRIXCIiCiAgICAgICAgICAgICAgICAgICAgaGFzX2lzc3Vlcz10cnVlCiAgICAgICAgICAgICAgICBmaQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBwcmludF9lcnJvciAiRmFpbGVkIHRvIGluc3RhbGwgdXYiCiAgICAgICAgICAgICAgICBoYXNfaXNzdWVzPXRydWUKICAgICAgICAgICAgZmkKICAgICAgICBlbHNlCiAgICAgICAgICAgIGhhc19pc3N1ZXM9dHJ1ZQogICAgICAgIGZpCiAgICBlbHNlCiAgICAgICAgcHJpbnRfc3RhdHVzICJ1dnggZm91bmQgYXQ6ICQoY29tbWFuZCAtdiB1dngpIgogICAgZmkKCiAgICAjIENoZWNrIENsYXVkZSBDTEkgKG9wdGlvbmFsKQogICAgaWYgY29tbWFuZCAtdiBjbGF1ZGUgPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgcHJpbnRfc3RhdHVzICJjbGF1ZGUgQ0xJIGZvdW5kIgogICAgZWxzZQogICAgICAgIHByaW50X2luZm8gImNsYXVkZSBDTEkgbm90IGZvdW5kIChvcHRpb25hbCkiCiAgICAgICAgcHJpbnRfaW5mbyAiSW5zdGFsbCBmcm9tOiBodHRwczovL2NsYXVkZS5haS9kb3dubG9hZCIKICAgIGZpCgogICAgIyBUZXN0IENocm9tYURCIE1DUCBzZXJ2ZXIKICAgIGlmIGNvbW1hbmQgLXYgdXZ4ID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgIHByaW50X2luZm8gIlRlc3RpbmcgQ2hyb21hREIgTUNQIHNlcnZlci4uLiIKICAgICAgICBpZiBydW5fd2l0aF90aW1lb3V0IDUgdXZ4IC1xcSAiJENIUk9NQV9NQ1BfVkVSU0lPTiIgLS1oZWxwID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgICAgICBwcmludF9zdGF0dXMgIkNocm9tYURCIE1DUCBzZXJ2ZXIgaXMgYXZhaWxhYmxlIgogICAgICAgIGVsc2UKICAgICAgICAgICAgcHJpbnRfaW5mbyAiQ2hyb21hREIgTUNQIHNlcnZlciB3aWxsIGJlIGluc3RhbGxlZCBvbiBmaXJzdCB1c2UiCiAgICAgICAgZmkKICAgIGZpCgogICAgaWYgW1sgIiRoYXNfaXNzdWVzIiA9PSAidHJ1ZSIgXV07IHRoZW4KICAgICAgICBwcmludF9lcnJvciAiTWlzc2luZyByZXF1aXJlZCBkZXBlbmRlbmNpZXMiCiAgICAgICAgZXhpdCAxCiAgICBmaQp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBNQUlOIFNFVFVQIEZVTkNUSU9OUwojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0Kc2V0dXBfcHJvamVjdF9kaXJlY3RvcnkoKSB7CiAgICBsb2NhbCBwcm9qZWN0X25hbWU9IiQxIgogICAgbG9jYWwgcHJvamVjdF9wYXRoPSIkMiIKCiAgICAjIFZhbGlkYXRlIGlucHV0cwogICAgaWYgW1sgLW4gIiRwcm9qZWN0X25hbWUiIF1dICYmICEgdmFsaWRhdGVfcHJvamVjdF9uYW1lICIkcHJvamVjdF9uYW1lIjsgdGhlbgogICAgICAgIGV4aXQgMQogICAgZmkKCiAgICBpZiAhIHZhbGlkYXRlX3BhdGggIiRwcm9qZWN0X3BhdGgiOyB0aGVuCiAgICAgICAgZXhpdCAxCiAgICBmaQoKICAgICMgRGV0ZXJtaW5lIHByb2plY3QgZGlyZWN0b3J5CiAgICBpZiBbWyAteiAiJHByb2plY3RfbmFtZSIgXV07IHRoZW4KICAgICAgICAjIFVzZSBjdXJyZW50IGRpcmVjdG9yeQogICAgICAgIFBST0pFQ1RfRElSPSIkKHB3ZCkiCiAgICAgICAgUFJPSkVDVF9OQU1FPSIkKGJhc2VuYW1lICIkUFJPSkVDVF9ESVIiKSIKICAgICAgICBwcmludF9oZWFkZXIgIvCfmoAgU2V0dGluZyB1cCBDaHJvbWFEQiBpbiBjdXJyZW50IGRpcmVjdG9yeSIKICAgICAgICBwcmludF9pbmZvICJQcm9qZWN0OiAkUFJPSkVDVF9OQU1FIgogICAgICAgIHByaW50X2luZm8gIlBhdGg6ICRQUk9KRUNUX0RJUiIKICAgIGVsc2UKICAgICAgICBQUk9KRUNUX0RJUj0iJHByb2plY3RfcGF0aC8kcHJvamVjdF9uYW1lIgogICAgICAgIFBST0pFQ1RfTkFNRT0iJHByb2plY3RfbmFtZSIKICAgICAgICBwcmludF9oZWFkZXIgIvCfmoAgU2V0dGluZyB1cCBDaHJvbWFEQiBmb3I6ICRwcm9qZWN0X25hbWUiCiAgICAgICAgcHJpbnRfaW5mbyAiUGF0aDogJFBST0pFQ1RfRElSIgoKICAgICAgICAjIENyZWF0ZSBvciB2ZXJpZnkgZGlyZWN0b3J5CiAgICAgICAgaWYgW1sgLWQgIiRQUk9KRUNUX0RJUiIgXV07IHRoZW4KICAgICAgICAgICAgcHJpbnRfaW5mbyAiRGlyZWN0b3J5IGV4aXN0cyIKICAgICAgICAgICAgaWYgISBwcm9tcHRfeWVzICJBZGQgQ2hyb21hREIgdG8gZXhpc3RpbmcgcHJvamVjdD8iOyB0aGVuCiAgICAgICAgICAgICAgICBwcmludF9pbmZvICJTZXR1cCBjYW5jZWxsZWQiCiAgICAgICAgICAgICAgICBleGl0IDAKICAgICAgICAgICAgZmkKICAgICAgICBlbHNlCiAgICAgICAgICAgIGlmIFtbICIkRFJZX1JVTiIgPT0gIjEiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgY3JlYXRlIGRpcmVjdG9yeTogJFBST0pFQ1RfRElSIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBta2RpciAtcCAiJFBST0pFQ1RfRElSIgogICAgICAgICAgICAgICAgcHJpbnRfc3RhdHVzICJDcmVhdGVkIGRpcmVjdG9yeSIKICAgICAgICAgICAgICAgIHRvdWNoX3RyYWNrICIkUFJPSkVDVF9ESVIiCiAgICAgICAgICAgIGZpCiAgICAgICAgZmkKCiAgICAgICAgIyBPbmx5IGNkIGlmIG5vdCBpbiBkcnktcnVuIG1vZGUgKGRpcmVjdG9yeSB3b24ndCBleGlzdCBpbiBkcnktcnVuKQogICAgICAgIGlmIFtbICIkRFJZX1JVTiIgIT0gIjEiIF1dOyB0aGVuCiAgICAgICAgICAgIGNkICIkUFJPSkVDVF9ESVIiCiAgICAgICAgZmkKICAgIGZpCn0KCmNyZWF0ZV9kaXJlY3Rvcnlfc3RydWN0dXJlKCkgewogICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgZGlyZWN0b3J5IHN0cnVjdHVyZS4uLiIKCiAgICBsb2NhbCBkaXJzPSgiLmNocm9tYSIgIi5jaHJvbWEvY29udGV4dCIgImNsYXVkZWRvY3MiICJiaW4iICJ0ZW1wbGF0ZXMiKQogICAgZm9yIGRpciBpbiAiJHtkaXJzW0BdfSI7IGRvCiAgICAgICAgaWYgW1sgISAtZCAiJGRpciIgXV07IHRoZW4KICAgICAgICAgICAgaWYgW1sgIiREUllfUlVOIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICAgICAgICAgIHByaW50X2luZm8gIltkcnktcnVuXSBXb3VsZCBjcmVhdGUgZGlyZWN0b3J5OiAkZGlyIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBta2RpciAtcCAiJGRpciIKICAgICAgICAgICAgICAgIHRvdWNoX3RyYWNrICIkZGlyIgogICAgICAgICAgICAgICAgZGVidWdfbG9nICJDcmVhdGVkIGRpcmVjdG9yeTogJGRpciIKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZG9uZQoKICAgIHByaW50X3N0YXR1cyAiRGlyZWN0b3J5IHN0cnVjdHVyZSByZWFkeSIKfQoKY3JlYXRlX21jcF9jb25maWcoKSB7CiAgICBwcmludF9pbmZvICJDb25maWd1cmluZyBNQ1Agc2VydmVyLi4uIgoKICAgIGxvY2FsIHV2eF9jbWQ9InV2eCIgICMgVXNlIGNvbW1hbmQgbmFtZSwgbm90IGZ1bGwgcGF0aAogICAgbG9jYWwgZGF0YV9kaXI9IiR7REFUQV9ESVJfT1ZFUlJJREU6LSQocHdkKS8uY2hyb21hfSIKCiAgICAjIFZhbGlkYXRlIHRoZSBkYXRhIGRpcmVjdG9yeSBwYXRoCiAgICBpZiAhIHZhbGlkYXRlX3BhdGggIiRkYXRhX2RpciI7IHRoZW4KICAgICAgICBwcmludF9lcnJvciAiSW52YWxpZCBkYXRhIGRpcmVjdG9yeSBwYXRoIgogICAgICAgIGV4aXQgMQogICAgZmkKCiAgICAjIEVuc3VyZSBkYXRhIGRpcmVjdG9yeSBkb2Vzbid0IGVzY2FwZSBwcm9qZWN0IChza2lwIGluIGRyeS1ydW4gc2luY2UgZGlyIGRvZXNuJ3QgZXhpc3QpCiAgICBpZiBbWyAiJERSWV9SVU4iICE9ICIxIiBdXTsgdGhlbgogICAgICAgIGFzc2VydF93aXRoaW4gIiRkYXRhX2RpciIgIiQocHdkKSIKICAgIGZpCgogICAgaWYgW1sgLWYgIi5tY3AuanNvbiIgXV07IHRoZW4KICAgICAgICBwcmludF9pbmZvICJFeGlzdGluZyAubWNwLmpzb24gZm91bmQiCgogICAgICAgIGlmICEganNvbl92YWxpZGF0ZSAiLm1jcC5qc29uIjsgdGhlbgogICAgICAgICAgICBwcmludF9lcnJvciAiRXhpc3RpbmcgLm1jcC5qc29uIGlzIGludmFsaWQiCiAgICAgICAgICAgIGlmIHByb21wdF95ZXMgIkJhY2t1cCBhbmQgY3JlYXRlIG5ldyBjb25maWc/IjsgdGhlbgogICAgICAgICAgICAgICAgYmFja3VwX2lmX2V4aXN0cyAiLm1jcC5qc29uIgogICAgICAgICAgICAgICAgU0tJUF9NQ1A9ZmFsc2UKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgZXhpdCAxCiAgICAgICAgICAgIGZpCiAgICAgICAgZWxpZiBncmVwIC1xICciY2hyb21hIicgLm1jcC5qc29uIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgICAgIHByaW50X2luZm8gIkNocm9tYURCIGFscmVhZHkgY29uZmlndXJlZCIKICAgICAgICAgICAgaWYgcHJvbXB0X3llcyAiVXBkYXRlIENocm9tYURCIGNvbmZpZ3VyYXRpb24/IjsgdGhlbgogICAgICAgICAgICAgICAgYmFja3VwX2lmX2V4aXN0cyAiLm1jcC5qc29uIgogICAgICAgICAgICAgICAgU0tJUF9NQ1A9ZmFsc2UKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgU0tJUF9NQ1A9dHJ1ZQogICAgICAgICAgICBmaQogICAgICAgIGVsc2UKICAgICAgICAgICAgcHJpbnRfaW5mbyAiTWVyZ2luZyBDaHJvbWFEQiBpbnRvIGV4aXN0aW5nIGNvbmZpZ3VyYXRpb24iCiAgICAgICAgICAgIGJhY2t1cF9pZl9leGlzdHMgIi5tY3AuanNvbiIKCiAgICAgICAgICAgIGxvY2FsIG1lcmdlZF9jb25maWcKICAgICAgICAgICAgbWVyZ2VkX2NvbmZpZz0kKGpzb25fbWVyZ2VfbWNwX2NvbmZpZyAiLm1jcC5qc29uIiAiJHV2eF9jbWQiICIkZGF0YV9kaXIiKQoKICAgICAgICAgICAgd3JpdGVfZmlsZV9zYWZlICIubWNwLmpzb24iICIkbWVyZ2VkX2NvbmZpZyIKICAgICAgICAgICAgY2htb2QgNjAwIC5tY3AuanNvbiAyPi9kZXYvbnVsbCB8fCB0cnVlCiAgICAgICAgICAgIFNLSVBfTUNQPXRydWUKICAgICAgICBmaQogICAgZWxzZQogICAgICAgIFNLSVBfTUNQPWZhbHNlCiAgICBmaQoKICAgIGlmIFtbICIkU0tJUF9NQ1AiICE9ICJ0cnVlIiBdXTsgdGhlbgogICAgICAgIGxvY2FsIG1jcF9jb25maWcKICAgICAgICBtY3BfY29uZmlnPSQoanNvbl9lbWl0X21jcF9jb25maWcgIiR1dnhfY21kIiAiJGRhdGFfZGlyIikKCiAgICAgICAgd3JpdGVfZmlsZV9zYWZlICIubWNwLmpzb24iICIkbWNwX2NvbmZpZyIKICAgICAgICBjaG1vZCA2MDAgLm1jcC5qc29uIDI+L2Rldi9udWxsIHx8IHRydWUKICAgIGZpCgogICAgIyBWYWxpZGF0ZSB0aGUgZmluYWwgY29uZmlnCiAgICBpZiBbWyAiJERSWV9SVU4iICE9ICIxIiBdXSAmJiAhIGpzb25fdmFsaWRhdGUgIi5tY3AuanNvbiI7IHRoZW4KICAgICAgICBwcmludF9lcnJvciAiRmFpbGVkIHRvIGNyZWF0ZSB2YWxpZCBNQ1AgY29uZmlndXJhdGlvbiIKICAgICAgICBleGl0IDEKICAgIGZpCgogICAgcHJpbnRfc3RhdHVzICJNQ1AgY29uZmlndXJhdGlvbiBjb21wbGV0ZSIKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgQ0xBVURFLk1EIE1FUkdFIEZVTkNUSU9OUwojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBJbnRlbGxpZ2VudGx5IG1lcmdlIGV4aXN0aW5nIENMQVVERS5tZCB3aXRoIENocm9tYURCIHRlbXBsYXRlCm1lcmdlX2NsYXVkZV9tZCgpIHsKICAgIGxvY2FsIGV4aXN0aW5nX2ZpbGU9IiQxIgogICAgbG9jYWwgcHJvamVjdF9jb2xsZWN0aW9uPSIkMiIKCiAgICAjIElmIG5vIGV4aXN0aW5nIGZpbGUsIHJldHVybiBlbXB0eSB0byBzaWduYWwgdGVtcGxhdGUgc2hvdWxkIGJlIHVzZWQKICAgIGlmIFtbICEgLWYgIiRleGlzdGluZ19maWxlIiBdXTsgdGhlbgogICAgICAgIHJldHVybiAxCiAgICBmaQoKICAgIGxvY2FsIGV4aXN0aW5nX2NvbnRlbnQKICAgIGV4aXN0aW5nX2NvbnRlbnQ9JChjYXQgIiRleGlzdGluZ19maWxlIikKCiAgICAjIENoZWNrIGlmIGV4aXN0aW5nIGZpbGUgYWxyZWFkeSBoYXMgQ2hyb21hIGNvbmZpZ3VyYXRpb24KICAgIGlmIGdyZXAgLXEgIlByb2plY3QgTWVtb3J5IChDaHJvbWEpIiAiJGV4aXN0aW5nX2ZpbGUiIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgIyBTdHJhdGVneSAxOiBVcGRhdGUgY29sbGVjdGlvbiBuYW1lcyBpbiBleGlzdGluZyBDaHJvbWEgY29uZmlnCiAgICAgICAgZGVidWdfbG9nICJFeGlzdGluZyBDTEFVREUubWQgaGFzIENocm9tYSAtIHVwZGF0aW5nIGNvbGxlY3Rpb24gbmFtZXMiCgogICAgICAgIGVjaG8gIiMgQ0xBVURFLm1kIOKAlCBQcm9qZWN0IENvbnRyYWN0IChBdXRvLVVwZGF0ZWQpCgokKGVjaG8gIiRleGlzdGluZ19jb250ZW50IiB8IHNlZCAicy9Db2xsZWN0aW9uIFxgW15cYF0qXGAvQ29sbGVjdGlvbiBcYCR7cHJvamVjdF9jb2xsZWN0aW9ufVxgL2ciIHwgXAogICBzZWQgInMvXCJjb2xsZWN0aW9uX25hbWVcIjogXCJbXlwiXSpcIi9cImNvbGxlY3Rpb25fbmFtZVwiOiBcIiR7cHJvamVjdF9jb2xsZWN0aW9ufVwiL2ciKQoKPCEtLSBBdXRvLXVwZGF0ZWQgY29sbGVjdGlvbiB0byAke3Byb2plY3RfY29sbGVjdGlvbn0gYXQgJChkYXRlICslWS0lbS0lZFwgJUg6JU06JVMpIC0tPiIKICAgICAgICByZXR1cm4gMAogICAgZWxzZQogICAgICAgICMgU3RyYXRlZ3kgMjogRnVsbCBtZXJnZSAtIHByZXNlcnZlIHVzZXIgY29udGVudCwgYWRkIENocm9tYQogICAgICAgIGRlYnVnX2xvZyAiRXhpc3RpbmcgQ0xBVURFLm1kIGxhY2tzIENocm9tYSAtIHBlcmZvcm1pbmcgZnVsbCBtZXJnZSIKCiAgICAgICAgY2F0IDw8RU9GCiMgQ0xBVURFLm1kIOKAlCBQcm9qZWN0IENvbnRyYWN0IChBdXRvLU1lcmdlZCkKCioqUHVycG9zZSoqOiBGb2xsb3cgdGhpcyBpbiBldmVyeSBzZXNzaW9uIGZvciB0aGlzIHJlcG8uIEtlZXAgbWVtb3J5IHNoYXJwLiBLZWVwIG91dHB1dHMgY29uY3JldGUuIEN1dCByZXdvcmsuCgojIyDwn6egIFByb2plY3QgTWVtb3J5IChDaHJvbWEpClVzZSBzZXJ2ZXIgXGBjaHJvbWFcYC4gQ29sbGVjdGlvbiBcYCR7cHJvamVjdF9jb2xsZWN0aW9ufVxgLgoKTG9nIGFmdGVyIGFueSBjb25maXJtZWQgZml4LCBkZWNpc2lvbiwgZ290Y2hhLCBvciBwcmVmZXJlbmNlLgoKKipTY2hlbWE6KioKLSAqKmRvY3VtZW50cyoqOiAx4oCTMiBzZW50ZW5jZXMuIFVuZGVyIDMwMCBjaGFycy4KLSAqKm1ldGFkYXRhcyoqOiBcYHsgInR5cGUiOiJkZWNpc2lvbnxmaXh8dGlwfHByZWZlcmVuY2UiLCAidGFncyI6ImNvbW1hLHNlcGFyYXRlZCIsICJzb3VyY2UiOiJmaWxlfFBSfHNwZWN8aXNzdWUiIH1cYAotICoqaWRzKio6IHN0YWJsZSBzdHJpbmcgaWYgdXBkYXRpbmcgdGhlIHNhbWUgZmFjdC4KCiMjIyBDaHJvbWEgQ2FsbHMKXGBcYFxgamF2YXNjcmlwdAovLyBDcmVhdGUgb25jZToKbWNwX19jaHJvbWFfX2Nocm9tYV9jcmVhdGVfY29sbGVjdGlvbiB7ICJjb2xsZWN0aW9uX25hbWUiOiAiJHtwcm9qZWN0X2NvbGxlY3Rpb259IiB9CgovLyBBZGQ6Cm1jcF9fY2hyb21hX19jaHJvbWFfYWRkX2RvY3VtZW50cyB7CiAgImNvbGxlY3Rpb25fbmFtZSI6ICIke3Byb2plY3RfY29sbGVjdGlvbn0iLAogICJkb2N1bWVudHMiOiBbIjx0ZXh0PiJdLAogICJtZXRhZGF0YXMiOiBbeyJ0eXBlIjoiPHR5cGU+IiwidGFncyI6ImEsYixjIiwic291cmNlIjoiPHNyYz4ifV0sCiAgImlkcyI6IFsiPHN0YWJsZS1pZD4iXQp9CgovLyBRdWVyeSAoc3RhcnQgd2l0aCA1OyBlc2NhbGF0ZSBvbmx5IGlmIDwzIHN0cm9uZyBoaXRzKToKbWNwX19jaHJvbWFfX2Nocm9tYV9xdWVyeV9kb2N1bWVudHMgewogICJjb2xsZWN0aW9uX25hbWUiOiAiJHtwcm9qZWN0X2NvbGxlY3Rpb259IiwKICAicXVlcnlfdGV4dHMiOiBbIjxxdWVyeT4iXSwKICAibl9yZXN1bHRzIjogNQp9ClxgXGBcYAoKLS0tCgojIyDwn5OdIFlvdXIgT3JpZ2luYWwgSW5zdHJ1Y3Rpb25zCgoke2V4aXN0aW5nX2NvbnRlbnR9CgotLS0KCiMjIPCflI0gUmV0cmlldmFsIENoZWNrbGlzdCBCZWZvcmUgQ29kaW5nCjEuIFF1ZXJ5IENocm9tYSBmb3IgcmVsYXRlZCBtZW1vcmllcy4KMi4gQ2hlY2sgcmVwbyBmaWxlcyB0aGF0IG1hdGNoIHRoZSB0YXNrLgozLiBMaXN0IG9wZW4gUFJzIG9yIGlzc3VlcyB0aGF0IHRvdWNoIHRoZSBzYW1lIGFyZWEuCjQuIE9ubHkgdGhlbiBwcm9wb3NlIGNoYW5nZXMuCgojIyDimqEgQWN0aXZhdGlvbgpSZWFkIHRoaXMgZmlsZSBhdCBzZXNzaW9uIHN0YXJ0LgpGb2xsb3cgeW91ciBvcmlnaW5hbCBpbnN0cnVjdGlvbnMgYWJvdmUsIHRoZW4gYWN0aXZhdGUgQ2hyb21hIG1lbW9yeS4KUnVuIFxgYmluL2Nocm9tYS1zdGF0cy5weVxgIGFuZCBhbm5vdW5jZTogKipDb250cmFjdCBsb2FkZWQuIFVzaW5nIENocm9tYSAke3Byb2plY3RfY29sbGVjdGlvbn0uIEZvdW5kIFtOXSBtZW1vcmllcyAoYnkgdHlwZSAuLi4pLioqCgojIyDwn6e5IFNlc3Npb24gSHlnaWVuZQpQcnVuZSB0byBsYXN0IDIwIHR1cm5zIGlmIGNvbnRleHQgZ2V0cyBoZWF2eS4gU2F2ZSBsb25nIG91dHB1dHMgaW4gXGAuL2JhY2t1cHMvXGAgYW5kIGVjaG8gcGF0aHMuCgojIyDwn5OBIE91dHB1dCBQb2xpY3kKRm9yIGNvZGUsIHJldHVybiB1bmlmaWVkIGRpZmYgb3IgcGF0Y2hhYmxlIGZpbGVzLiBGb3Igc2NyaXB0cywgaW5jbHVkZSBleGFjdCBjb21tYW5kcyBhbmQgcGF0aHMuCgojIyDwn5uh77iPIFNhZmV0eQpObyBzZWNyZXRzIGluIFxgLmNocm9tYVxgIG9yIHRyYW5zY3JpcHRzLiBSZXNwZWN0IHJhdGUgbGltaXRzLiBQcm9wb3NlIGJhdGNoaW5nIGlmIG5lZWRlZC4KCjwhLS0gQXV0by1tZXJnZWQgd2l0aCBleGlzdGluZyBjb250ZW50IGF0ICQoZGF0ZSArJVktJW0tJWRcICVIOiVNOiVTKSAtLT4KPCEtLSBPcmlnaW5hbCBwcmVzZXJ2ZWQgaW4gQ0xBVURFLm1kLm9yaWdpbmFsIC0tPgpFT0YKICAgICAgICByZXR1cm4gMAogICAgZmkKfQpjcmVhdGVfY2xhdWRlX21kKCkgewogICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcvbWVyZ2luZyBDTEFVREUubWQuLi4iCgogICAgbG9jYWwgbmVlZHNfdGVtcGxhdGU9dHJ1ZQogICAgbG9jYWwgbWVyZ2VkX2NvbnRlbnQ9IiIKCiAgICAjIFRyeSB0byBtZXJnZSBpZiBleGlzdGluZyBmaWxlIGV4aXN0cwogICAgaWYgW1sgLWYgIkNMQVVERS5tZCIgXV07IHRoZW4KICAgICAgICBwcmludF9pbmZvICJGb3VuZCBleGlzdGluZyBDTEFVREUubWQgLSBhdHRlbXB0aW5nIGludGVsbGlnZW50IG1lcmdlLi4uIgogICAgICAgIGJhY2t1cF9jbGF1ZGVfbWQgICMgQWx3YXlzIGJhY2t1cCBmaXJzdAoKICAgICAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgbWVyZ2UgZXhpc3RpbmcgQ0xBVURFLm1kIHdpdGggQ2hyb21hIHRlbXBsYXRlIgogICAgICAgICAgICBuZWVkc190ZW1wbGF0ZT1mYWxzZQogICAgICAgIGVsc2UKICAgICAgICAgICAgIyBUcnkgdG8gbWVyZ2UKICAgICAgICAgICAgbWVyZ2VkX2NvbnRlbnQ9JChtZXJnZV9jbGF1ZGVfbWQgIkNMQVVERS5tZC5vcmlnaW5hbCIgIiRQUk9KRUNUX0NPTExFQ1RJT04iKQogICAgICAgICAgICBpZiBbWyAkPyAtZXEgMCBdXTsgdGhlbgogICAgICAgICAgICAgICAgd3JpdGVfZmlsZV9zYWZlICJDTEFVREUubWQiICIkbWVyZ2VkX2NvbnRlbnQiCiAgICAgICAgICAgICAgICBwcmludF9zdGF0dXMgIuKcqCBNZXJnZWQgZXhpc3RpbmcgQ0xBVURFLm1kIHdpdGggQ2hyb21hIGNvbmZpZ3VyYXRpb24iCiAgICAgICAgICAgICAgICBwcmludF9pbmZvICIgICBPcmlnaW5hbCBwcmVzZXJ2ZWQgaW4gQ0xBVURFLm1kLm9yaWdpbmFsIgogICAgICAgICAgICAgICAgbmVlZHNfdGVtcGxhdGU9ZmFsc2UKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZmkKCiAgICAjIElmIG5vIG1lcmdlIHBlcmZvcm1lZCwgdXNlIHRlbXBsYXRlCiAgICBpZiBbWyAiJG5lZWRzX3RlbXBsYXRlIiA9PSAidHJ1ZSIgXV07IHRoZW4KICAgICAgICAjIEVuc3VyZSB0ZW1wbGF0ZSBleGlzdHMgb3Igc2VlZCBhIG1pbmltYWwgb25lCiAgICAgICAgaWYgW1sgISAtZiAidGVtcGxhdGVzL0NMQVVERS5tZC50cGwiIF1dOyB0aGVuCiAgICAgICAgICAgIHByaW50X3dhcm5pbmcgInRlbXBsYXRlcy9DTEFVREUubWQudHBsIG5vdCBmb3VuZC4gU2VlZGluZyBtaW5pbWFsIHRlbXBsYXRlLi4uIgogICAgICAgICAgICBpZiBbWyAiJERSWV9SVU4iICE9ICIxIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgbWtkaXIgLXAgdGVtcGxhdGVzCiAgICAgICAgICAgICAgICBjYXQgPiB0ZW1wbGF0ZXMvQ0xBVURFLm1kLnRwbCA8PCdUUEwnCiMgQ0xBVURFLm1kIOKAlCBQcm9qZWN0IENvbnRyYWN0ClVzZSBzZXJ2ZXIgXGBjaHJvbWFcYC4gQ29sbGVjdGlvbiBcYFwke1BST0pFQ1RfQ09MTEVDVElPTn1cYC4KQmVmb3JlIHByb3Bvc2luZyB3b3JrLCBxdWVyeSBDaHJvbWEgZm9yIHByaW9yIGZhY3RzLgpcYFxgXGBqYXZhc2NyaXB0Cm1jcF9fY2hyb21hX19jaHJvbWFfY3JlYXRlX2NvbGxlY3Rpb24geyAiY29sbGVjdGlvbl9uYW1lIjogIlwke1BST0pFQ1RfQ09MTEVDVElPTn0iIH0KbWNwX19jaHJvbWFfX2Nocm9tYV9xdWVyeV9kb2N1bWVudHMgeyAiY29sbGVjdGlvbl9uYW1lIjogIlwke1BST0pFQ1RfQ09MTEVDVElPTn0iLCAicXVlcnlfdGV4dHMiOiBbInByb2plY3QgZGVjaXNpb25zIHByZWZlcmVuY2VzIGZpeGVzIl0sICJuX3Jlc3VsdHMiOiA1IH0KXGBcYFxgClJlYWQgXGAuY2hyb21hL2NvbnRleHQvKi5tZFxgIGF0IHNlc3Npb24gc3RhcnQgYW5kIGxpc3Qgd2hhdCB5b3UgdXNlZC4KUnVuIFxgYmluL2Nocm9tYS1zdGF0cy5weVxgIGFuZCBhbm5vdW5jZSBjb3VudHMgYnkgdHlwZS4KVFBMCiAgICAgICAgICAgIGZpCiAgICAgICAgZmkKCiAgICAgICAgcmVxdWlyZV9jbWQgZW52c3Vic3QgIkluc3RhbGwgZ2V0dGV4dDoKICBtYWNPUzogYnJldyBpbnN0YWxsIGdldHRleHQgJiYgYnJldyBsaW5rIC0tZm9yY2UgZ2V0dGV4dAogIExpbnV4OiBhcHQtZ2V0IGluc3RhbGwgZ2V0dGV4dCIKICAgICAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgcmVuZGVyIENMQVVERS5tZCBmcm9tIHRlbXBsYXRlcy9DTEFVREUubWQudHBsIHVzaW5nIFBST0pFQ1RfQ09MTEVDVElPTj1cJHtQUk9KRUNUX0NPTExFQ1RJT059IgogICAgICAgIGVsc2UKICAgICAgICAgICAgQ09OVEVOVD0iXCQoZW52IFBST0pFQ1RfQ09MTEVDVElPTj0iXCRQUk9KRUNUX0NPTExFQ1RJT04iIGVudnN1YnN0IDwgdGVtcGxhdGVzL0NMQVVERS5tZC50cGwpIgogICAgICAgICAgICB3cml0ZV9maWxlX3NhZmUgIkNMQVVERS5tZCIgIlwkQ09OVEVOVCIKICAgICAgICAgICAgcHJpbnRfc3RhdHVzICJDcmVhdGVkIENMQVVERS5tZCBmcm9tIHRlbXBsYXRlIgogICAgICAgIGZpCiAgICBmaQp9CgpjcmVhdGVfZ2l0aWdub3JlKCkgewogICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgLmdpdGlnbm9yZS4uLiIKCiAgICBpZiBbWyAtZiAiLmdpdGlnbm9yZSIgXV07IHRoZW4KICAgICAgICBwcmludF93YXJuaW5nICIuZ2l0aWdub3JlIGFscmVhZHkgZXhpc3RzIgogICAgICAgIGlmICEgcHJvbXB0X3llcyAiTWVyZ2UgQ2hyb21hREIgZW50cmllcyBpbnRvIGV4aXN0aW5nIC5naXRpZ25vcmU/IjsgdGhlbgogICAgICAgICAgICBwcmludF9pbmZvICJTa2lwcGluZyAuZ2l0aWdub3JlIgogICAgICAgICAgICByZXR1cm4gMAogICAgICAgIGZpCiAgICAgICAgYmFja3VwX2lmX2V4aXN0cyAiLmdpdGlnbm9yZSIKICAgIGZpCgogICAgbG9jYWwgY29udGVudD0nIyBDaHJvbWFEQiBsb2NhbCBkYXRhYmFzZQouY2hyb21hLwoqLmNocm9tYQoKIyBNQ1AgY29uZmlndXJhdGlvbiAodHJhY2tlZCBieSBkZWZhdWx0KS4KIyBUbyBpZ25vcmUgaXQsIHVuY29tbWVudCB0aGUgbmV4dCBsaW5lOgojIC5tY3AuanNvbgoKIyBNZW1vcnkgZXhwb3J0cyAob3B0aW9uYWwgLSB0cmFjayBmb3IgaGlzdG9yeSkKY2xhdWRlZG9jcy8qLm1kCgojIFB5dGhvbgpfX3B5Y2FjaGVfXy8KKi5weVtjb2RdCi5weXRlc3RfY2FjaGUvCgojIE9TCi5EU19TdG9yZQpUaHVtYnMuZGIKCiMgSURFCi52c2NvZGUvCi5pZGVhLwoqLnN3cCcKCiAgICBpZiBbWyAtZiAiLmdpdGlnbm9yZSIgXV07IHRoZW4KICAgICAgICAjIE1lcmdlOiBhZGQgQ2hyb21hREItc3BlY2lmaWMgbGluZXMgaWYgbm90IHByZXNlbnQKICAgICAgICBsb2NhbCBjaHJvbWFfbGluZXM9KCIuY2hyb21hLyIgIiouY2hyb21hIikKICAgICAgICBmb3IgbGluZSBpbiAiJHtjaHJvbWFfbGluZXNbQF19IjsgZG8KICAgICAgICAgICAgaWYgISBncmVwIC1GcSAiJGxpbmUiIC5naXRpZ25vcmUgMj4vZGV2L251bGw7IHRoZW4KICAgICAgICAgICAgICAgIGlmIFtbICIkRFJZX1JVTiIgPT0gIjEiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgcHJpbnRfaW5mbyAiW2RyeS1ydW5dIFdvdWxkIGFkZCB0byAuZ2l0aWdub3JlOiAkbGluZSIKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBlY2hvICIkbGluZSIgPj4gLmdpdGlnbm9yZQogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCiAgICAgICAgdG91Y2hfdHJhY2sgIi5naXRpZ25vcmUiCiAgICAgICAgcHJpbnRfc3RhdHVzICJVcGRhdGVkIC5naXRpZ25vcmUiCiAgICBlbHNlCiAgICAgICAgd3JpdGVfZmlsZV9zYWZlICIuZ2l0aWdub3JlIiAiJGNvbnRlbnQiCiAgICAgICAgcHJpbnRfc3RhdHVzICJDcmVhdGVkIC5naXRpZ25vcmUiCiAgICBmaQp9CgpjcmVhdGVfaW5pdF9kb2NzKCkgewogICAgcHJpbnRfaW5mbyAiQ3JlYXRpbmcgaW5pdGlhbGl6YXRpb24gZG9jdW1lbnRhdGlvbi4uLiIKCiAgICBsb2NhbCBjb250ZW50PScjIENocm9tYURCIEluaXRpYWxpemF0aW9uCgojIyBBdXRvbWF0aWMgU2V0dXAKV2hlbiB5b3Ugc3RhcnQgQ2xhdWRlIGluIHRoaXMgcHJvamVjdDoKMS4gQ2xhdWRlIHJlYWRzIENMQVVERS5tZAoyLiBDaGVja3MgaWYgQ2hyb21hREIgY29sbGVjdGlvbiBleGlzdHMKMy4gQ3JlYXRlcyBjb2xsZWN0aW9uIGlmIG5lZWRlZAo0LiBTdGFydHMgbG9nZ2luZyBtZW1vcmllcwoKIyMgU3RhcnRpbmcgQ2xhdWRlCmBgYGJhc2gKIyBGcm9tIHByb2plY3QgZGlyZWN0b3J5OgpjbGF1ZGUKCiMgT3IgdXNlIHRoZSBsYXVuY2hlcjoKLi9zdGFydC1jbGF1ZGUtY2hyb21hLnNoCmBgYAoKIyMgTWFudWFsIENvbW1hbmRzIChpZiBuZWVkZWQpCgojIyMgQ3JlYXRlIENvbGxlY3Rpb24KYGBgamF2YXNjcmlwdAptY3BfX2Nocm9tYV9fY2hyb21hX2NyZWF0ZV9jb2xsZWN0aW9uIHsgImNvbGxlY3Rpb25fbmFtZSI6ICIke1BST0pFQ1RfQ09MTEVDVElPTn0iIH0KYGBgCgojIyMgVGVzdCBDb2xsZWN0aW9uCmBgYGphdmFzY3JpcHQKbWNwX19jaHJvbWFfX2Nocm9tYV9xdWVyeV9kb2N1bWVudHMgewogICJjb2xsZWN0aW9uX25hbWUiOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IiwKICAicXVlcnlfdGV4dHMiOiBbInRlc3QiXSwKICAibl9yZXN1bHRzIjogNQp9CmBgYAoKIyMjIEFkZCBNZW1vcnkKYGBgamF2YXNjcmlwdAptY3BfX2Nocm9tYV9fY2hyb21hX2FkZF9kb2N1bWVudHMgewogICJjb2xsZWN0aW9uX25hbWUiOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IiwKICAiZG9jdW1lbnRzIjogWyJZb3VyIG1lbW9yeSB0ZXh0IGhlcmUiXSwKICAibWV0YWRhdGFzIjogW3sKICAgICJ0eXBlIjogInRpcCIsCiAgICAidGFncyI6ICJyZWxldmFudCx0YWdzIiwKICAgICJzb3VyY2UiOiAibWFudWFsIiwKICAgICJjb25maWRlbmNlIjogMC44CiAgfV0sCiAgImlkcyI6IFsidW5pcXVlLWlkLTAwMSJdCn0KYGBgCgojIyBUcm91Ymxlc2hvb3RpbmcKCiMjIyBNQ1Agc2VydmVyIG5vdCBmb3VuZAotIEVuc3VyZSAubWNwLmpzb24gZXhpc3RzIGluIHByb2plY3Qgcm9vdAotIFN0YXJ0IENsYXVkZSBmcm9tIHRoZSBwcm9qZWN0IGRpcmVjdG9yeQotIENoZWNrOiBgY2F0IC5tY3AuanNvbiB8IGpxIC5gCgojIyMgQ29sbGVjdGlvbiBlcnJvcnMKLSBWZXJpZnkgQ2hyb21hREIgZGlyZWN0b3J5IGV4aXN0czogYGxzIC1sYSAuY2hyb21hL2AKLSBUcnkgcmVjcmVhdGluZyBjb2xsZWN0aW9uIHdpdGggY29tbWFuZCBhYm92ZQoKIyMjIE1lbW9yeSBub3QgcGVyc2lzdGluZwotIENoZWNrIGNvbGxlY3Rpb24gbmFtZSBtYXRjaGVzOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IgotIFZlcmlmeSBtZXRhZGF0YSBmb3JtYXQgaXMgY29ycmVjdAotIEVuc3VyZSB1bmlxdWUgSURzIGZvciBlYWNoIG1lbW9yeScKCiAgICB3cml0ZV9maWxlX3NhZmUgImNsYXVkZWRvY3MvSU5JVF9JTlNUUlVDVElPTlMubWQiICIkY29udGVudCIKICAgIHByaW50X3N0YXR1cyAiQ3JlYXRlZCBpbml0aWFsaXphdGlvbiBkb2N1bWVudGF0aW9uIgp9CgpjcmVhdGVfbGF1bmNoZXIoKSB7CiAgICBwcmludF9pbmZvICJDcmVhdGluZyBsYXVuY2hlciBzY3JpcHQuLi4iCgogICAgbG9jYWwgY29udGVudD0nIyEvdXNyL2Jpbi9lbnYgYmFzaApzZXQgLWV1byBwaXBlZmFpbAoKIyBDaGVjayBpZiBjb25maWcgZXhpc3RzCmlmIFtbICEgLWYgIi5tY3AuanNvbiIgXV07IHRoZW4KICAgIGVjaG8gIuKdjCBObyBNQ1AgY29uZmlnIGZvdW5kIGluIHRoaXMgZGlyZWN0b3J5IgogICAgZWNobyAiUnVuIHRoZSBDaHJvbWFEQiBzZXR1cCBzY3JpcHQgZmlyc3QiCiAgICBleGl0IDEKZmkKCiMgVmFsaWRhdGUgSlNPTgppZiAhIGpxIC1lIC4gLm1jcC5qc29uID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgZWNobyAi4p2MIEludmFsaWQgLm1jcC5qc29uIGNvbmZpZ3VyYXRpb24iCiAgICBlY2hvICJSdW46IGpxIC4gLm1jcC5qc29uIHRvIHNlZSB0aGUgZXJyb3IiCiAgICBleGl0IDEKZmkKCiMgT3B0aW9uYWw6IGJ1bXAgcmVnaXN0cnkgdXNhZ2UgaWYgaGVscGVyIGV4aXN0cwppZiBbWyAteCAiYmluL3JlZ2lzdHJ5LnNoIiBdXTsgdGhlbgogIGJpbi9yZWdpc3RyeS5zaCBidW1wICIkUFdEIiB8fCB0cnVlCmZpCmVjaG8gIvCfmoAgU3RhcnRpbmcgQ2xhdWRlIHdpdGggQ2hyb21hREIuLi4iCmV4ZWMgY2xhdWRlICIkQCInCgogICAgd3JpdGVfZmlsZV9zYWZlICJzdGFydC1jbGF1ZGUtY2hyb21hLnNoIiAiJGNvbnRlbnQiCgogICAgaWYgW1sgIiREUllfUlVOIiAhPSAiMSIgXV07IHRoZW4KICAgICAgICBjaG1vZCAreCBzdGFydC1jbGF1ZGUtY2hyb21hLnNoCiAgICBlbHNlCiAgICAgICAgcHJpbnRfaW5mbyAiW2RyeS1ydW5dIFdvdWxkIG1ha2UgZXhlY3V0YWJsZTogc3RhcnQtY2xhdWRlLWNocm9tYS5zaCIKICAgIGZpCgogICAgcHJpbnRfc3RhdHVzICJDcmVhdGVkIGxhdW5jaGVyIHNjcmlwdCIKfQoKc2V0dXBfc2hlbGxfZnVuY3Rpb24oKSB7CiAgICBwcmludF9oZWFkZXIgIvCfmoAgT3B0aW9uYWw6IFNtYXJ0IFNoZWxsIEZ1bmN0aW9uIgoKICAgIHByaW50X2luZm8gIkFkZCBhIGdsb2JhbCAnY2xhdWRlLWNocm9tYScgZnVuY3Rpb24gdG8geW91ciBzaGVsbD8iCiAgICBlY2hvICIiCiAgICBlY2hvIC1lICIke0JMVUV9VGhpcyBmdW5jdGlvbiB3aWxsOiR7TkN9IgogICAgZWNobyAiICDinIUgV29yayBmcm9tIGFueSBkaXJlY3RvcnkgaW4geW91ciBwcm9qZWN0IHRyZWUiCiAgICBlY2hvICIgIOKchSBBdXRvLWRldGVjdCBDaHJvbWFEQiBjb25maWcgZmlsZXMiCiAgICBlY2hvICIgIOKchSBGYWxsIGJhY2sgdG8gcmVndWxhciBDbGF1ZGUgaWYgbm8gY29uZmlnIGZvdW5kIgogICAgZWNobyAiIgoKICAgIGlmICEgcHJvbXB0X3llcyAiQWRkIGNsYXVkZS1jaHJvbWEgZnVuY3Rpb24/IjsgdGhlbgogICAgICAgIHByaW50X2luZm8gIlNraXBwaW5nIHNoZWxsIGZ1bmN0aW9uIHNldHVwIgogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIGxvY2FsIHNoZWxsX3JjCiAgICBzaGVsbF9yYz0kKGRldGVjdF9zaGVsbF9yYykKICAgIGxvY2FsIHNoZWxsX25hbWUKICAgIHNoZWxsX25hbWU9JChiYXNlbmFtZSAiJHtTSEVMTDotL2Jpbi9iYXNofSIpCgogICAgcHJpbnRfaW5mbyAiU2hlbGw6ICRzaGVsbF9uYW1lIgogICAgcHJpbnRfaW5mbyAiQ29uZmlnOiAkc2hlbGxfcmMiCgogICAgIyBDaGVjayBpZiBmdW5jdGlvbiBhbHJlYWR5IGV4aXN0cwogICAgaWYgW1sgLWYgIiRzaGVsbF9yYyIgXV0gJiYgZ3JlcCAtcSAiY2xhdWRlLWNocm9tYSgpXHxmdW5jdGlvbiBjbGF1ZGUtY2hyb21hIiAiJHNoZWxsX3JjIiAyPi9kZXYvbnVsbDsgdGhlbgogICAgICAgIHByaW50X2luZm8gImNsYXVkZS1jaHJvbWEgZnVuY3Rpb24gYWxyZWFkeSBleGlzdHMiCiAgICAgICAgcmV0dXJuIDAKICAgIGZpCgogICAgYmFja3VwX2lmX2V4aXN0cyAiJHNoZWxsX3JjIgoKICAgIGxvY2FsIGZ1bmN0aW9uX2NvbnRlbnQKCiAgICBpZiBbWyAiJHNoZWxsX25hbWUiID09ICJmaXNoIiBdXTsgdGhlbgogICAgICAgIGZ1bmN0aW9uX2NvbnRlbnQ9JwojIENocm9tYURCIFNtYXJ0IEZ1bmN0aW9uIC0gQWRkZWQgYnkgY2xhdWRlLWNocm9tYS5zaCB2My4zCmZ1bmN0aW9uIGNsYXVkZS1jaHJvbWEgLS1kZXNjcmlwdGlvbiAiU3RhcnQgQ2xhdWRlIHdpdGggYXV0by1kZXRlY3RlZCBDaHJvbWFEQiBjb25maWciCiAgICBzZXQgY29uZmlnX2ZpbGUgIiIKICAgIHNldCBzZWFyY2hfZGlyICIkUFdEIgoKICAgICMgU2VhcmNoIHVwd2FyZCBmb3IgLm1jcC5qc29uCiAgICB3aGlsZSB0ZXN0ICIkc2VhcmNoX2RpciIgIT0gIi8iCiAgICAgICAgaWYgdGVzdCAtZiAiJHNlYXJjaF9kaXIvLm1jcC5qc29uIgogICAgICAgICAgICBzZXQgY29uZmlnX2ZpbGUgIiRzZWFyY2hfZGlyLy5tY3AuanNvbiIKICAgICAgICAgICAgYnJlYWsKICAgICAgICBlbmQKICAgICAgICBzZXQgc2VhcmNoX2RpciAoZGlybmFtZSAiJHNlYXJjaF9kaXIiKQogICAgZW5kCgogICAgaWYgdGVzdCAtbiAiJGNvbmZpZ19maWxlIgogICAgICAgIHNldCBwcm9qZWN0X2RpciAoZGlybmFtZSAiJGNvbmZpZ19maWxlIikKICAgICAgICBlY2hvICJVc2luZyBDaHJvbWFEQiBwcm9qZWN0OiAkcHJvamVjdF9kaXIiCiAgICAgICAgY2QgIiRwcm9qZWN0X2RpciIKICAgICAgICBpZiB0ZXN0IChjb3VudCAkYXJndikgLWVxIDAKICAgICAgICAgICAgY2xhdWRlCiAgICAgICAgZWxzZQogICAgICAgICAgICBjbGF1ZGUgJGFyZ3YKICAgICAgICBlbmQKICAgIGVsc2UKICAgICAgICBlY2hvICJObyBDaHJvbWFEQiBjb25maWcgZm91bmQgLSB1c2luZyByZWd1bGFyIENsYXVkZSIKICAgICAgICBpZiB0ZXN0IChjb3VudCAkYXJndikgLWVxIDAKICAgICAgICAgICAgY2xhdWRlCiAgICAgICAgZWxzZQogICAgICAgICAgICBjbGF1ZGUgJGFyZ3YKICAgICAgICBlbmQKICAgIGVuZAplbmQnCiAgICBlbHNlCiAgICAgICAgZnVuY3Rpb25fY29udGVudD0nCiMgQ2hyb21hREIgU21hcnQgRnVuY3Rpb24gLSBBZGRlZCBieSBjbGF1ZGUtY2hyb21hLnNoIHYzLjMKY2xhdWRlLWNocm9tYSgpIHsKICAgIGxvY2FsIGNvbmZpZ19maWxlPSIiCiAgICBsb2NhbCBzZWFyY2hfZGlyPSIkUFdEIgoKICAgICMgU2VhcmNoIHVwd2FyZCBmb3IgLm1jcC5qc29uCiAgICB3aGlsZSBbWyAiJHNlYXJjaF9kaXIiICE9ICIvIiBdXTsgZG8KICAgICAgICBpZiBbWyAtZiAiJHNlYXJjaF9kaXIvLm1jcC5qc29uIiBdXTsgdGhlbgogICAgICAgICAgICBjb25maWdfZmlsZT0iJHNlYXJjaF9kaXIvLm1jcC5qc29uIgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICAgICAgc2VhcmNoX2Rpcj0kKGRpcm5hbWUgIiRzZWFyY2hfZGlyIikKICAgIGRvbmUKCiAgICBpZiBbWyAtbiAiJGNvbmZpZ19maWxlIiBdXTsgdGhlbgogICAgICAgIGxvY2FsIHByb2plY3RfZGlyPSQoZGlybmFtZSAiJGNvbmZpZ19maWxlIikKICAgICAgICBlY2hvICLwn6egIFVzaW5nIENocm9tYURCIHByb2plY3Q6ICRwcm9qZWN0X2RpciIKICAgICAgICBjZCAiJHByb2plY3RfZGlyIgogICAgICAgIGlmIFtbICQjIC1lcSAwIF1dOyB0aGVuCiAgICAgICAgICAgIGNsYXVkZQogICAgICAgIGVsc2UKICAgICAgICAgICAgY2xhdWRlICIkQCIKICAgICAgICBmaQogICAgZWxzZQogICAgICAgIGVjaG8gIuKEue+4jyAgTm8gQ2hyb21hREIgY29uZmlnIGZvdW5kIC0gdXNpbmcgcmVndWxhciBDbGF1ZGUiCiAgICAgICAgaWYgW1sgJCMgLWVxIDAgXV07IHRoZW4KICAgICAgICAgICAgY2xhdWRlCiAgICAgICAgZWxzZQogICAgICAgICAgICBjbGF1ZGUgIiRAIgogICAgICAgIGZpCiAgICBmaQp9JwogICAgZmkKCiAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgIHByaW50X2luZm8gIltkcnktcnVuXSBXb3VsZCBhZGQgY2xhdWRlLWNocm9tYSBmdW5jdGlvbiB0byAkc2hlbGxfcmMiCiAgICBlbHNlCiAgICAgICAgZWNobyAiJGZ1bmN0aW9uX2NvbnRlbnQiID4+ICIkc2hlbGxfcmMiCiAgICAgICAgdG91Y2hfdHJhY2sgIiRzaGVsbF9yYyIKICAgICAgICBwcmludF9zdGF0dXMgIkFkZGVkIGNsYXVkZS1jaHJvbWEgZnVuY3Rpb24iCiAgICBmaQoKICAgIHByaW50X2luZm8gIlJlc3RhcnQgdGVybWluYWwgb3IgcnVuOiBzb3VyY2UgJHNoZWxsX3JjIgp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBNSUdSQVRJT04gRlJPTSBPTERFUiBWRVJTSU9OUwojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KbWlncmF0ZV9mcm9tX3YzKCkgewogICAgIyBDaGVjayBmb3IgdjMuMC8zLjEgaW52YWxpZCBjb25maWd1cmF0aW9uCiAgICBpZiBbWyAtZiAiLmNsYXVkZS9zZXR0aW5ncy5sb2NhbC5qc29uIiBdXTsgdGhlbgogICAgICAgIGlmIGdyZXAgLXEgJyJpbnN0cnVjdGlvbnMiJyAuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24gMj4vZGV2L251bGw7IHRoZW4KICAgICAgICAgICAgcHJpbnRfaW5mbyAiRm91bmQgaW5jb21wYXRpYmxlIHYzLjAvMy4xIGNvbmZpZ3VyYXRpb24iCgogICAgICAgICAgICBpZiBwcm9tcHRfeWVzICJNaWdyYXRlIGZyb20gcHJldmlvdXMgdmVyc2lvbj8iOyB0aGVuCiAgICAgICAgICAgICAgICBiYWNrdXBfaWZfZXhpc3RzICIuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24iCgogICAgICAgICAgICAgICAgaWYgW1sgIiREUllfUlVOIiAhPSAiMSIgXV07IHRoZW4KICAgICAgICAgICAgICAgICAgICBybSAtZiAuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24KCiAgICAgICAgICAgICAgICAgICAgIyBSZW1vdmUgZW1wdHkgLmNsYXVkZSBkaXJlY3RvcnkKICAgICAgICAgICAgICAgICAgICBpZiBbWyAtZCAiLmNsYXVkZSIgXV0gJiYgW1sgLXogIiQobHMgLUEgLmNsYXVkZSAyPi9kZXYvbnVsbCkiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgICAgIHJtZGlyIC5jbGF1ZGUKICAgICAgICAgICAgICAgICAgICBmaQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHByaW50X2luZm8gIltkcnktcnVuXSBXb3VsZCByZW1vdmUgaW52YWxpZCAuY2xhdWRlL3NldHRpbmdzLmxvY2FsLmpzb24iCiAgICAgICAgICAgICAgICBmaQoKICAgICAgICAgICAgICAgIHByaW50X3N0YXR1cyAiTWlncmF0ZWQgZnJvbSB2My4wLzMuMSIKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZmkKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgU0hFTEwgRlVOQ1RJT04gTUlHUkFUSU9OCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQpjaGVja19icm9rZW5fc2hlbGxfZnVuY3Rpb24oKSB7CiAgICBwcmludF9pbmZvICJDaGVja2luZyBmb3IgYnJva2VuIHNoZWxsIGZ1bmN0aW9ucy4uLiIKCiAgICBsb2NhbCBzaGVsbF9yYwogICAgc2hlbGxfcmM9JChkZXRlY3Rfc2hlbGxfcmMpCgogICAgaWYgW1sgISAtZiAiJHNoZWxsX3JjIiBdXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgICMgQ2hlY2sgaWYgZnVuY3Rpb24gZXhpc3RzIGFuZCBpcyBicm9rZW4gKGxvb2tpbmcgZm9yIG9sZCBjb25maWcgZmlsZSkKICAgIGlmIGdyZXAgLXEgImNsYXVkZS1jaHJvbWEoKSIgIiRzaGVsbF9yYyIgMj4vZGV2L251bGw7IHRoZW4KICAgICAgICBpZiBncmVwIC1xICdcLmNsYXVkZS9zZXR0aW5nc1wubG9jYWxcLmpzb24nICIkc2hlbGxfcmMiIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgICAgIHByaW50X3dhcm5pbmcgIkZvdW5kIG91dGRhdGVkIGNsYXVkZS1jaHJvbWEgZnVuY3Rpb24gaW4gJHNoZWxsX3JjIgogICAgICAgICAgICBwcmludF9pbmZvICJUaGlzIGZ1bmN0aW9uIGxvb2tzIGZvciB0aGUgb2xkIGNvbmZpZyBmaWxlIGxvY2F0aW9uIgoKICAgICAgICAgICAgaWYgcHJvbXB0X3llcyAiVXBkYXRlIGNsYXVkZS1jaHJvbWEgZnVuY3Rpb24gdG8gd29yayB3aXRoIGN1cnJlbnQgdmVyc2lvbj8iOyB0aGVuCiAgICAgICAgICAgICAgICBiYWNrdXBfaWZfZXhpc3RzICIkc2hlbGxfcmMiCgogICAgICAgICAgICAgICAgaWYgW1sgIiREUllfUlVOIiAhPSAiMSIgXV07IHRoZW4KICAgICAgICAgICAgICAgICAgICAjIFJlbW92ZSBvbGQgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICBsb2NhbCB0bXBfZmlsZT0iJHtzaGVsbF9yY30udG1wLiQkIgogICAgICAgICAgICAgICAgICAgIGF3ayAnCiAgICAgICAgICAgICAgICAgICAgICAgIC9eW1s6c3BhY2U6XV0qY2xhdWRlLWNocm9tYVwoXCkvIHsgaW5fZnVuYz0xIH0KICAgICAgICAgICAgICAgICAgICAgICAgaW5fZnVuYyAmJiAvXn0vIHsgaW5fZnVuYz0wOyBuZXh0IH0KICAgICAgICAgICAgICAgICAgICAgICAgIWluX2Z1bmMgeyBwcmludCB9CiAgICAgICAgICAgICAgICAgICAgJyAiJHNoZWxsX3JjIiA+ICIkdG1wX2ZpbGUiCgogICAgICAgICAgICAgICAgICAgIG12ICIkdG1wX2ZpbGUiICIkc2hlbGxfcmMiCgogICAgICAgICAgICAgICAgICAgICMgQWRkIHVwZGF0ZWQgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICBsb2NhbCBmdW5jdGlvbl9jb250ZW50PScKIyBDaHJvbWFEQiBTbWFydCBGdW5jdGlvbiAtIFVwZGF0ZWQgYnkgY2xhdWRlLWNocm9tYS5zaCB2My4zCmNsYXVkZS1jaHJvbWEoKSB7CiAgICBsb2NhbCBjb25maWdfZmlsZT0iIgogICAgbG9jYWwgc2VhcmNoX2Rpcj0iJFBXRCIKCiAgICAjIFNlYXJjaCB1cHdhcmQgZm9yIC5tY3AuanNvbgogICAgd2hpbGUgW1sgIiRzZWFyY2hfZGlyIiAhPSAiLyIgXV07IGRvCiAgICAgICAgaWYgW1sgLWYgIiRzZWFyY2hfZGlyLy5tY3AuanNvbiIgXV07IHRoZW4KICAgICAgICAgICAgY29uZmlnX2ZpbGU9IiRzZWFyY2hfZGlyLy5tY3AuanNvbiIKICAgICAgICAgICAgYnJlYWsKICAgICAgICBmaQogICAgICAgIHNlYXJjaF9kaXI9JChkaXJuYW1lICIkc2VhcmNoX2RpciIpCiAgICBkb25lCgogICAgaWYgW1sgLW4gIiRjb25maWdfZmlsZSIgXV07IHRoZW4KICAgICAgICBsb2NhbCBwcm9qZWN0X2Rpcj0kKGRpcm5hbWUgIiRjb25maWdfZmlsZSIpCiAgICAgICAgZWNobyAi8J+noCBVc2luZyBDaHJvbWFEQiBwcm9qZWN0OiAkcHJvamVjdF9kaXIiCiAgICAgICAgY2QgIiRwcm9qZWN0X2RpciIKICAgICAgICBpZiBbWyAkIyAtZXEgMCBdXTsgdGhlbgogICAgICAgICAgICBjbGF1ZGUKICAgICAgICBlbHNlCiAgICAgICAgICAgIGNsYXVkZSAiJEAiCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBlY2hvICLihLnvuI8gIE5vIENocm9tYURCIGNvbmZpZyBmb3VuZCAtIHVzaW5nIHJlZ3VsYXIgQ2xhdWRlIgogICAgICAgIGlmIFtbICQjIC1lcSAwIF1dOyB0aGVuCiAgICAgICAgICAgIGNsYXVkZQogICAgICAgIGVsc2UKICAgICAgICAgICAgY2xhdWRlICIkQCIKICAgICAgICBmaQogICAgZmkKfScKICAgICAgICAgICAgICAgICAgICBlY2hvICIkZnVuY3Rpb25fY29udGVudCIgPj4gIiRzaGVsbF9yYyIKICAgICAgICAgICAgICAgICAgICBwcmludF9zdGF0dXMgIlVwZGF0ZWQgY2xhdWRlLWNocm9tYSBmdW5jdGlvbiIKICAgICAgICAgICAgICAgICAgICBwcmludF9pbmZvICJSZXN0YXJ0IHRlcm1pbmFsIG9yIHJ1bjogc291cmNlICRzaGVsbF9yYyIKICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgdXBkYXRlIGNsYXVkZS1jaHJvbWEgZnVuY3Rpb24gaW4gJHNoZWxsX3JjIgogICAgICAgICAgICAgICAgZmkKICAgICAgICAgICAgZmkKICAgICAgICBmaQogICAgZmkKfQoKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiMgTUNQIENPTkZJRyBUSU1FT1VUIFZBTElEQVRJT04KIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmNoZWNrX21jcF90aW1lb3V0X3NldHRpbmdzKCkgewogICAgaWYgW1sgISAtZiAiLm1jcC5qc29uIiBdXTsgdGhlbgogICAgICAgIHJldHVybiAwCiAgICBmaQoKICAgIHByaW50X2luZm8gIkNoZWNraW5nIGV4aXN0aW5nIC5tY3AuanNvbiBmb3IgdGltZW91dCBzZXR0aW5ncy4uLiIKCiAgICAjIENoZWNrIGlmIHRpbWVvdXQgc2V0dGluZ3MgZXhpc3QKICAgIGxvY2FsIGhhc190aW1lb3V0X3NldHRpbmdzPTAKCiAgICBpZiBqcSAtZSAnLm1jcFNlcnZlcnMuY2hyb21hLmVudi5DSFJPTUFfU0VSVkVSX0tFRVBfQUxJVkUnIC5tY3AuanNvbiA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICBpZiBbWyAkKGpxIC1yICcubWNwU2VydmVycy5jaHJvbWEuZW52LkNIUk9NQV9TRVJWRVJfS0VFUF9BTElWRScgLm1jcC5qc29uKSA9PSAiMCIgXV07IHRoZW4KICAgICAgICAgICAgaGFzX3RpbWVvdXRfc2V0dGluZ3M9MQogICAgICAgIGZpCiAgICBmaQoKICAgIGlmIFtbICIkaGFzX3RpbWVvdXRfc2V0dGluZ3MiIC1lcSAwIF1dOyB0aGVuCiAgICAgICAgcHJpbnRfd2FybmluZyAiRXhpc3RpbmcgLm1jcC5qc29uIGxhY2tzIGluZmluaXRlIHRpbWVvdXQgc2V0dGluZ3MiCiAgICAgICAgcHJpbnRfaW5mbyAiV2l0aG91dCB0aGVzZSBzZXR0aW5ncywgQ2hyb21hREIgbWF5IGRpc2Nvbm5lY3QgYWZ0ZXIgaW5hY3Rpdml0eSIKCiAgICAgICAgaWYgcHJvbXB0X3llcyAiVXBkYXRlIC5tY3AuanNvbiB3aXRoIHRpbWVvdXQgcHJldmVudGlvbiBzZXR0aW5ncz8iOyB0aGVuCiAgICAgICAgICAgIGJhY2t1cF9pZl9leGlzdHMgIi5tY3AuanNvbiIKCiAgICAgICAgICAgIGlmIFtbICIkRFJZX1JVTiIgIT0gIjEiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICAjIFVwZGF0ZSB0aGUgY29uZmlnIHdpdGggdGltZW91dCBzZXR0aW5ncwogICAgICAgICAgICAgICAgbG9jYWwgdXBkYXRlZF9jb25maWcKICAgICAgICAgICAgICAgIHVwZGF0ZWRfY29uZmlnPSQoanEgJwogICAgICAgICAgICAgICAgICAgIC5tY3BTZXJ2ZXJzLmNocm9tYS5lbnYuQ0hST01BX1NFUlZFUl9LRUVQX0FMSVZFID0gIjAiIHwKICAgICAgICAgICAgICAgICAgICAubWNwU2VydmVycy5jaHJvbWEuZW52LkNIUk9NQV9DTElFTlRfVElNRU9VVCA9ICIwIiB8CiAgICAgICAgICAgICAgICAgICAgLm1jcFNlcnZlcnMuY2hyb21hLmluaXRpYWxpemF0aW9uT3B0aW9ucy50aW1lb3V0ID0gMCB8CiAgICAgICAgICAgICAgICAgICAgLm1jcFNlcnZlcnMuY2hyb21hLmluaXRpYWxpemF0aW9uT3B0aW9ucy5rZWVwQWxpdmUgPSB0cnVlIHwKICAgICAgICAgICAgICAgICAgICAubWNwU2VydmVycy5jaHJvbWEuaW5pdGlhbGl6YXRpb25PcHRpb25zLnJldHJ5QXR0ZW1wdHMgPSA1CiAgICAgICAgICAgICAgICAnIC5tY3AuanNvbikKCiAgICAgICAgICAgICAgICBlY2hvICIkdXBkYXRlZF9jb25maWciID4gLm1jcC5qc29uCiAgICAgICAgICAgICAgICBwcmludF9zdGF0dXMgIlVwZGF0ZWQgLm1jcC5qc29uIHdpdGggdGltZW91dCBwcmV2ZW50aW9uIHNldHRpbmdzIgogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICBwcmludF9pbmZvICJbZHJ5LXJ1bl0gV291bGQgdXBkYXRlIC5tY3AuanNvbiB3aXRoIHRpbWVvdXQgc2V0dGluZ3MiCiAgICAgICAgICAgIGZpCiAgICAgICAgZmkKICAgIGVsc2UKICAgICAgICBwcmludF9zdGF0dXMgIlRpbWVvdXQgc2V0dGluZ3MgYWxyZWFkeSBjb25maWd1cmVkIGNvcnJlY3RseSIKICAgIGZpCn0KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIEZJTkFMIFNVTU1BUlkKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CnByaW50X3N1bW1hcnkoKSB7CiAgICBwcmludF9oZWFkZXIgIuKcqCBTZXR1cCBDb21wbGV0ZSEiCgogICAgZWNobyAiUHJvamVjdDogJFBST0pFQ1RfTkFNRSIKICAgIGVjaG8gIlBhdGg6ICRQUk9KRUNUX0RJUiIKICAgIGVjaG8gIiIKCiAgICBpZiBbWyAiJERSWV9SVU4iID09ICIxIiBdXTsgdGhlbgogICAgICAgIHByaW50X3dhcm5pbmcgIkRSWSBSVU4gTU9ERSAtIE5vIGNoYW5nZXMgd2VyZSBtYWRlIgogICAgICAgIGVjaG8gIiIKICAgICAgICBlY2hvICJUbyBhcHBseSBjaGFuZ2VzLCBydW4gd2l0aG91dCBEUllfUlVOOiIKICAgICAgICBlY2hvICIgIERSWV9SVU49MCAkMCAkKiIKICAgIGVsc2UKICAgICAgICBwcmludF9zdGF0dXMgIkNocm9tYURCIE1DUCBzZXJ2ZXIgY29uZmlndXJlZCIKICAgICAgICBwcmludF9zdGF0dXMgIlByb2plY3QgaW5zdHJ1Y3Rpb25zIGluIENMQVVERS5tZCIKICAgICAgICBwcmludF9zdGF0dXMgIkFsbCBmaWxlcyBiYWNrZWQgdXAgYmVmb3JlIG1vZGlmaWNhdGlvbiIKCiAgICAgICAgZWNobyAiIgogICAgICAgIHByaW50X2luZm8gIkRpcmVjdG9yeSBzdHJ1Y3R1cmU6IgogICAgICAgIGlmIGNvbW1hbmQgLXYgdHJlZSA+L2Rldi9udWxsIDI+JjE7IHRoZW4KICAgICAgICAgICAgdHJlZSAtYSAtTCAyIC4gMj4vZGV2L251bGwgfCBoZWFkIC0yMAogICAgICAgIGVsc2UKICAgICAgICAgICAgbHMgLWxhIC4gfCBoZWFkIC0xMAogICAgICAgIGZpCgogICAgICAgIGVjaG8gIiIKICAgICAgICBwcmludF9pbmZvICJOZXh0IHN0ZXBzOiIKICAgICAgICBlY2hvICIgIDEuIGNkIFwiJFBST0pFQ1RfRElSXCIiCiAgICAgICAgZWNobyAiICAyLiBSdW4gT05FIG9mIHRoZXNlIGNvbW1hbmRzOiIKICAgICAgICBlY2hvICIgICAgICQgY2xhdWRlICAgICAgICAgICAoc3RhcnRzIENsYXVkZSB3aXRoIENocm9tYURCKSIKICAgICAgICBlY2hvICIgICAgICQgLi9zdGFydC1jbGF1ZGUtY2hyb21hLnNoIgogICAgICAgIGVjaG8gIiAgMy4gQ2xhdWRlIGF1dG8taW5pdGlhbGl6ZXMgQ2hyb21hREIiCgogICAgICAgIGVjaG8gIiIKICAgICAgICBwcmludF9pbmZvICJUaGUgc3lzdGVtIHdpbGw6IgogICAgICAgIGVjaG8gIiAg4oCiIEF1dG8tZGV0ZWN0IC5tY3AuanNvbiBjb25maWd1cmF0aW9uIgogICAgICAgIGVjaG8gIiAg4oCiIEF1dG8tY3JlYXRlIGNvbGxlY3Rpb24gaWYgbmVlZGVkIgogICAgICAgIGVjaG8gIiAg4oCiIEF1dG8tbG9nIG1lbW9yaWVzIGR1cmluZyB3b3JrIgogICAgICAgIGVjaG8gIiAg4oCiIFBlcnNpc3Qga25vd2xlZGdlIGFjcm9zcyBzZXNzaW9ucyIKICAgIGZpCn0KCiMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQojIFBST0pFQ1QgUkVHSVNUUlkKIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CmFkZF90b19yZWdpc3RyeSgpIHsKICAgICMgVXNlIFhERyBjb25maWcgaG9tZSBpZiBhdmFpbGFibGUKICAgIGxvY2FsIGNvbmZpZ19kaXI9IiR7WERHX0NPTkZJR19IT01FOi0kSE9NRS8uY29uZmlnfSIKICAgIGxvY2FsIHJlZ2lzdHJ5PSIkY29uZmlnX2Rpci9jbGF1ZGUvY2hyb21hX3Byb2plY3RzLmpzb25sIgogICAgbG9jYWwgdGltZXN0YW1wPSQoZGF0ZSAtdSArJVktJW0tJWRUJUg6JU06JVNaKQoKICAgICMgQ3JlYXRlIHJlZ2lzdHJ5IGRpcmVjdG9yeSBpZiBuZWVkZWQKICAgIG1rZGlyIC1wICIkKGRpcm5hbWUgIiRyZWdpc3RyeSIpIgoKICAgICMgQWRkIGVudHJ5IGlmIG5vdCBhbHJlYWR5IHByZXNlbnQgKEpTT05MIGZvcm1hdCkKICAgIGlmICEgZ3JlcCAtRnEgIlwicGF0aFwiOlwiJFBST0pFQ1RfRElSXCIiICIkcmVnaXN0cnkiIDI+L2Rldi9udWxsOyB0aGVuCiAgICAgICAgcHJpbnRmICd7Im5hbWUiOiIlcyIsInBhdGgiOiIlcyIsImNvbGxlY3Rpb24iOiIlcyIsImRhdGFfZGlyIjoiJXMvLmNocm9tYSIsImNyZWF0ZWRfYXQiOiIlcyIsInNlc3Npb25zIjowfVxuJyBcCiAgICAgICAgICAgICIkUFJPSkVDVF9OQU1FIiAiJFBST0pFQ1RfRElSIiAiJFBST0pFQ1RfQ09MTEVDVElPTiIgIiRQUk9KRUNUX0RJUiIgIiR0aW1lc3RhbXAiID4+ICIkcmVnaXN0cnkiCiAgICBmaQp9CgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KIyBNQUlOIEVYRUNVVElPTgojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KbWFpbigpIHsKICAgICMgSGFuZGxlIGNvbW1hbmQtbGluZSBhcmd1bWVudHMKICAgIHdoaWxlIFtbICQjIC1ndCAwIF1dOyBkbwogICAgICAgIGNhc2UgIiQxIiBpbgogICAgICAgICAgICAtLWRyeS1ydW4pCiAgICAgICAgICAgICAgICBEUllfUlVOPTEKICAgICAgICAgICAgICAgIHByaW50X3dhcm5pbmcgIkRSWSBSVU4gTU9ERSAtIE5vIGNoYW5nZXMgd2lsbCBiZSBtYWRlIgogICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgLS1ub24taW50ZXJhY3RpdmUpCiAgICAgICAgICAgICAgICBOT05fSU5URVJBQ1RJVkU9MQogICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgLS15ZXN8LXkpCiAgICAgICAgICAgICAgICBBU1NVTUVfWUVTPTEKICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgIC0tZGVidWcpCiAgICAgICAgICAgICAgICBERUJVRz0xCiAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAtLXZlcnNpb24pCiAgICAgICAgICAgICAgICBlY2hvICJjbGF1ZGUtY2hyb21hLnNoIHZlcnNpb24gJFNDUklQVF9WRVJTSU9OIgogICAgICAgICAgICAgICAgZXhpdCAwCiAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAtLW1pbmltYWwpCiAgICAgICAgICAgICAgICBNSU5JTUFMPTEKICAgICAgICAgICAgICAgIEZVTEw9MAogICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgLS1mdWxsKQogICAgICAgICAgICAgICAgRlVMTD0xCiAgICAgICAgICAgICAgICBNSU5JTUFMPTAKICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgIC0tY29sbGVjdGlvbikKICAgICAgICAgICAgICAgIHNoaWZ0CiAgICAgICAgICAgICAgICBDSFJPTUFfQ09MTEVDVElPTl9PVkVSUklERT0iJHsxOi19IgogICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgLS1kYXRhLWRpcikKICAgICAgICAgICAgICAgIHNoaWZ0CiAgICAgICAgICAgICAgICBEQVRBX0RJUl9PVkVSUklERT0iJHsxOi19IgogICAgICAgICAgICAgICAgOzsKICAgICAgICAgICAgLS1wcmludC1jb2xsZWN0aW9uKQogICAgICAgICAgICAgICAgIyBKdXN0IHByaW50IHRoZSBjb2xsZWN0aW9uIG5hbWUgYW5kIGV4aXQKICAgICAgICAgICAgICAgIHNoaWZ0CiAgICAgICAgICAgICAgICBQUk9KRUNUX05BTUU9IiR7MTotJChiYXNlbmFtZSAiJFBXRCIpfSIKICAgICAgICAgICAgICAgIDogIiR7Q0hST01BX0NPTExFQ1RJT05fT1ZFUlJJREU6PX0iCiAgICAgICAgICAgICAgICBkZXJpdmVfY29sbGVjdGlvbl9uYW1lKCkgewogICAgICAgICAgICAgICAgICAgIGxvY2FsIGJhc2U9IiR7UFJPSkVDVF9OQU1FOi0kKGJhc2VuYW1lICIkUFdEIil9IgogICAgICAgICAgICAgICAgICAgIGlmIGNvbW1hbmQgLXYgaWNvbnYgPi9kZXYvbnVsbCAyPiYxOyB0aGVuCiAgICAgICAgICAgICAgICAgICAgICAgIGJhc2U9IiQocHJpbnRmICclcycgIiRiYXNlIiB8IGljb252IC1mIHV0Zi04IC10IGFzY2lpLy9UUkFOU0xJVCAyPi9kZXYvbnVsbCB8fCBwcmludGYgJyVzJyAiJGJhc2UiKSIKICAgICAgICAgICAgICAgICAgICBmaQogICAgICAgICAgICAgICAgICAgIGxvY2FsIG5vcm0KICAgICAgICAgICAgICAgICAgICBub3JtPSIkKHByaW50ZiAnJXMnICIkYmFzZSIgfCB0ciAnWzp1cHBlcjpdIC4tLycgJ1s6bG93ZXI6XV9fXycgfCBzZWQgJ3MvW15hLXowLTlfXS9fL2cnKSIKICAgICAgICAgICAgICAgICAgICBub3JtPSIke25vcm06MDo0OH0iCiAgICAgICAgICAgICAgICAgICAgcHJpbnRmICclc19tZW1vcnknICIkbm9ybSIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFBST0pFQ1RfQ09MTEVDVElPTj0iJHtDSFJPTUFfQ09MTEVDVElPTl9PVkVSUklERTotJChkZXJpdmVfY29sbGVjdGlvbl9uYW1lKX0iCiAgICAgICAgICAgICAgICBlY2hvICIkUFJPSkVDVF9DT0xMRUNUSU9OIgogICAgICAgICAgICAgICAgZXhpdCAwCiAgICAgICAgICAgICAgICA7OwogICAgICAgICAgICAtLWhlbHApCiAgICAgICAgICAgICAgICBlY2hvICJVc2FnZTogJDAgW1BST0pFQ1RfTkFNRV0gW1BST0pFQ1RfUEFUSF0gW09QVElPTlNdIgogICAgICAgICAgICAgICAgZWNobyAiIgogICAgICAgICAgICAgICAgZWNobyAiT3B0aW9uczoiCiAgICAgICAgICAgICAgICBlY2hvICIgIC0tZHJ5LXJ1biAgICAgICAgICBQcmV2aWV3IGNoYW5nZXMgd2l0aG91dCBhcHBseWluZyIKICAgICAgICAgICAgICAgIGVjaG8gIiAgLS1ub24taW50ZXJhY3RpdmUgIFJ1biB3aXRob3V0IHByb21wdHMiCiAgICAgICAgICAgICAgICBlY2hvICIgIC0teWVzLCAteSAgICAgICAgICBBc3N1bWUgeWVzIHRvIGFsbCBwcm9tcHRzIgogICAgICAgICAgICAgICAgZWNobyAiICAtLWRlYnVnICAgICAgICAgICAgU2hvdyBkZWJ1ZyBvdXRwdXQiCiAgICAgICAgICAgICAgICBlY2hvICIgIC0tY29sbGVjdGlvbiBOQU1FICBPdmVycmlkZSBjb2xsZWN0aW9uIG5hbWUiCiAgICAgICAgICAgICAgICBlY2hvICIgIC0tZGF0YS1kaXIgUEFUSCAgICBPdmVycmlkZSBkYXRhIGRpcmVjdG9yeSIKICAgICAgICAgICAgICAgIGVjaG8gIiAgLS1wcmludC1jb2xsZWN0aW9uIFByaW50IGNvbGxlY3Rpb24gbmFtZSBhbmQgZXhpdCIKICAgICAgICAgICAgICAgIGVjaG8gIiAgLS12ZXJzaW9uICAgICAgICAgIFNob3cgdmVyc2lvbiIKICAgICAgICAgICAgICAgIGVjaG8gIiAgLS1oZWxwICAgICAgICAgICAgIFNob3cgdGhpcyBoZWxwIgogICAgICAgICAgICAgICAgZWNobyAiIgogICAgICAgICAgICAgICAgZWNobyAiRW52aXJvbm1lbnQgdmFyaWFibGVzOiIKICAgICAgICAgICAgICAgIGVjaG8gIiAgRFJZX1JVTj0xICAgICAgICAgIFNhbWUgYXMgLS1kcnktcnVuIgogICAgICAgICAgICAgICAgZWNobyAiICBOT05fSU5URVJBQ1RJVkU9MSAgU2FtZSBhcyAtLW5vbi1pbnRlcmFjdGl2ZSIKICAgICAgICAgICAgICAgIGVjaG8gIiAgQVNTVU1FX1lFUz0xICAgICAgIFNhbWUgYXMgLS15ZXMiCiAgICAgICAgICAgICAgICBlY2hvICIgIERFQlVHPTEgICAgICAgICAgICBTYW1lIGFzIC0tZGVidWciCiAgICAgICAgICAgICAgICBleGl0IDAKICAgICAgICAgICAgICAgIDs7CiAgICAgICAgICAgICopCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgOzsKICAgICAgICBlc2FjCiAgICAgICAgc2hpZnQKICAgIGRvbmUKCiAgICAjIEdldCBwcm9qZWN0IG5hbWUgYW5kIHBhdGggZnJvbSByZW1haW5pbmcgYXJndW1lbnRzCiAgICBsb2NhbCBwcm9qZWN0X25hbWU9IiR7MTotfSIKICAgIGxvY2FsIHByb2plY3RfcGF0aD0iJHsyOi19IgoKICAgICMgU2FuaXRpemUgaW5wdXRzCiAgICBwcm9qZWN0X25hbWU9JChzYW5pdGl6ZV9pbnB1dCAiJHByb2plY3RfbmFtZSIpCgogICAgIyBEZWZhdWx0IHBhdGggZGV0ZWN0aW9uCiAgICBpZiBbWyAteiAiJHByb2plY3RfcGF0aCIgXV07IHRoZW4KICAgICAgICBpZiBbWyAteiAiJHByb2plY3RfbmFtZSIgXV07IHRoZW4KICAgICAgICAgICAgIyBObyBhcmd1bWVudHMgLSB1c2UgY3VycmVudCBkaXJlY3RvcnkKICAgICAgICAgICAgcHJvamVjdF9wYXRoPSIkKHB3ZCkiCiAgICAgICAgZWxpZiBbWyAtZCAiJEhPTUUvcHJvamVjdHMiIF1dOyB0aGVuCiAgICAgICAgICAgIHByb2plY3RfcGF0aD0iJEhPTUUvcHJvamVjdHMiCiAgICAgICAgZWxpZiBbWyAtZCAiJEhPTUUvRG9jdW1lbnRzL3Byb2plY3RzIiBdXTsgdGhlbgogICAgICAgICAgICBwcm9qZWN0X3BhdGg9IiRIT01FL0RvY3VtZW50cy9wcm9qZWN0cyIKICAgICAgICBlbGlmIFtbIC1kICIkSE9NRS9EZXNrdG9wL3Byb2plY3RzIiBdXTsgdGhlbgogICAgICAgICAgICBwcm9qZWN0X3BhdGg9IiRIT01FL0Rlc2t0b3AvcHJvamVjdHMiCiAgICAgICAgZWxzZQogICAgICAgICAgICBwcm9qZWN0X3BhdGg9IiRIT01FIgogICAgICAgICAgICBwcmludF9pbmZvICJVc2luZyBob21lIGRpcmVjdG9yeS4gQ29uc2lkZXIgY3JlYXRpbmcgfi9wcm9qZWN0cy8iCiAgICAgICAgZmkKICAgIGZpCgogICAgcHJvamVjdF9wYXRoPSQoc2FuaXRpemVfaW5wdXQgIiRwcm9qZWN0X3BhdGgiKQoKICAgICMgUnVuIHNldHVwCiAgICBjaGVja19wcmVyZXF1aXNpdGVzCiAgICBzZXR1cF9wcm9qZWN0X2RpcmVjdG9yeSAiJHByb2plY3RfbmFtZSIgIiRwcm9qZWN0X3BhdGgiCgogICAgIyBEZXJpdmUgYSBwZXItcHJvamVjdCBjb2xsZWN0aW9uIG5hbWUKICAgIDogIiR7Q0hST01BX0NPTExFQ1RJT05fT1ZFUlJJREU6PX0iCiAgICBkZXJpdmVfY29sbGVjdGlvbl9uYW1lKCkgewogICAgICAgIGxvY2FsIGJhc2U9IiR7UFJPSkVDVF9OQU1FOi0kKGJhc2VuYW1lICIkUFdEIil9IgogICAgICAgICMgVHJhbnNsaXRlcmF0ZSBub24tQVNDSUkgY2hhcmFjdGVycyBpZiBpY29udiBpcyBhdmFpbGFibGUKICAgICAgICBpZiBjb21tYW5kIC12IGljb252ID4vZGV2L251bGwgMj4mMTsgdGhlbgogICAgICAgICAgICBiYXNlPSIkKHByaW50ZiAnJXMnICIkYmFzZSIgfCBpY29udiAtZiB1dGYtOCAtdCBhc2NpaS8vVFJBTlNMSVQgMj4vZGV2L251bGwgfHwgcHJpbnRmICclcycgIiRiYXNlIikiCiAgICAgICAgZmkKICAgICAgICAjIG5vcm1hbGl6ZTogbG93ZXIsIHJlcGxhY2Ugbm9uIFthLXowLTlfXSB3aXRoIF8KICAgICAgICBsb2NhbCBub3JtCiAgICAgICAgbm9ybT0iJChwcmludGYgJyVzJyAiJGJhc2UiIHwgdHIgJ1s6dXBwZXI6XSAuLS8nICdbOmxvd2VyOl1fX18nIHwgc2VkICdzL1teYS16MC05X10vXy9nJykiCiAgICAgICAgIyBjbGFtcCB0byByZWFzb25hYmxlIGxlbmd0aAogICAgICAgIG5vcm09IiR7bm9ybTowOjQ4fSIKICAgICAgICBwcmludGYgJyVzX21lbW9yeScgIiRub3JtIgogICAgfQogICAgUFJPSkVDVF9DT0xMRUNUSU9OPSIke0NIUk9NQV9DT0xMRUNUSU9OX09WRVJSSURFOi0kKGRlcml2ZV9jb2xsZWN0aW9uX25hbWUpfSIKCiAgICBtaWdyYXRlX2Zyb21fdjMKICAgIGNoZWNrX2Jyb2tlbl9zaGVsbF9mdW5jdGlvbgogICAgY3JlYXRlX2RpcmVjdG9yeV9zdHJ1Y3R1cmUKICAgIGNyZWF0ZV9tY3BfY29uZmlnCiAgICBjaGVja19tY3BfdGltZW91dF9zZXR0aW5ncwogICAgY3JlYXRlX2NsYXVkZV9tZAogICAgZW5zdXJlX21lbW9yeV9kaXNjaXBsaW5lCiAgICBlbnN1cmVfc2V0dGluZ3NfbWVtb3J5X2Rpc2NpcGxpbmUKICAgIGNyZWF0ZV9naXRpZ25vcmUKICAgIGNyZWF0ZV9pbml0X2RvY3MKICAgIGNyZWF0ZV9sYXVuY2hlcgogICAgIyBTaGVsbCBmdW5jdGlvbiBpcyBPRkYgYnkgZGVmYXVsdDsgb25seSBpbiAtLWZ1bGwgbW9kZQogICAgaWYgW1sgIiRGVUxMIiA9PSAiMSIgXV07IHRoZW4KICAgICAgICBzZXR1cF9zaGVsbF9mdW5jdGlvbgogICAgZWxzZQogICAgICAgIHByaW50X2luZm8gIkxlYW4gbW9kZTogc2tpcHBpbmcgc2hlbGwgZnVuY3Rpb24gaW5zdGFsbGVyICh1c2UgLS1mdWxsIHRvIGVuYWJsZSkiCiAgICBmaQogICAgYWRkX3RvX3JlZ2lzdHJ5CiAgICBwcmludF9zdW1tYXJ5Cn0KCiMgUnVuIG1haW4gZnVuY3Rpb24KbWFpbiAiJEAi
SCRIPT_BASE64
chmod +x "$TEMP_DIR/claude-chroma.sh"

# Extract template
echo -e "${BLUE}⏳ Extracting template...${NC}"
mkdir -p "$PROJECT_DIR/templates"
base64 -d > "$PROJECT_DIR/templates/CLAUDE.md.tpl" <<'TEMPLATE_BASE64'
IyBDTEFVREUubWQg4oCUIFByb2plY3QgQ29udHJhY3QKCioqUHVycG9zZSoqOiBGb2xsb3cgdGhpcyBpbiBldmVyeSBzZXNzaW9uIGZvciB0aGlzIHJlcG8uIEtlZXAgbWVtb3J5IHNoYXJwLiBLZWVwIG91dHB1dHMgY29uY3JldGUuIEN1dCByZXdvcmsuCgojIyDwn6egIFByb2plY3QgTWVtb3J5IChDaHJvbWEpClVzZSBzZXJ2ZXIgYGNocm9tYWAuIENvbGxlY3Rpb24gYCR7UFJPSkVDVF9DT0xMRUNUSU9OfWAuCgpMb2cgYWZ0ZXIgYW55IGNvbmZpcm1lZCBmaXgsIGRlY2lzaW9uLCBnb3RjaGEsIG9yIHByZWZlcmVuY2UuCgoqKlNjaGVtYToqKgotICoqZG9jdW1lbnRzKio6IDHigJMyIHNlbnRlbmNlcy4gVW5kZXIgMzAwIGNoYXJzLgotICoqbWV0YWRhdGFzKio6IGB7ICJ0eXBlIjoiZGVjaXNpb258Zml4fHRpcHxwcmVmZXJlbmNlIiwgInRhZ3MiOiJjb21tYSxzZXBhcmF0ZWQiLCAic291cmNlIjoiZmlsZXxQUnxzcGVjfGlzc3VlIiB9YAotICoqaWRzKio6IHN0YWJsZSBzdHJpbmcgaWYgdXBkYXRpbmcgdGhlIHNhbWUgZmFjdC4KCiMjIyBDaHJvbWEgQ2FsbHMKYGBgamF2YXNjcmlwdAovLyBDcmVhdGUgb25jZToKbWNwX19jaHJvbWFfX2Nocm9tYV9jcmVhdGVfY29sbGVjdGlvbiB7ICJjb2xsZWN0aW9uX25hbWUiOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IiB9CgovLyBBZGQ6Cm1jcF9fY2hyb21hX19jaHJvbWFfYWRkX2RvY3VtZW50cyB7CiAgImNvbGxlY3Rpb25fbmFtZSI6ICIke1BST0pFQ1RfQ09MTEVDVElPTn0iLAogICJkb2N1bWVudHMiOiBbIjx0ZXh0PiJdLAogICJtZXRhZGF0YXMiOiBbeyJ0eXBlIjoiPHR5cGU+IiwidGFncyI6ImEsYixjIiwic291cmNlIjoiPHNyYz4ifV0sCiAgImlkcyI6IFsiPHN0YWJsZS1pZD4iXQp9CgovLyBRdWVyeSAoc3RhcnQgd2l0aCA1OyBlc2NhbGF0ZSBvbmx5IGlmIDwzIHN0cm9uZyBoaXRzKToKbWNwX19jaHJvbWFfX2Nocm9tYV9xdWVyeV9kb2N1bWVudHMgewogICJjb2xsZWN0aW9uX25hbWUiOiAiJHtQUk9KRUNUX0NPTExFQ1RJT059IiwKICAicXVlcnlfdGV4dHMiOiBbIjxxdWVyeT4iXSwKICAibl9yZXN1bHRzIjogNQp9CmBgYAoKIyMg8J+UjSBSZXRyaWV2YWwgQ2hlY2tsaXN0IEJlZm9yZSBDb2RpbmcKMS4gUXVlcnkgQ2hyb21hIGZvciByZWxhdGVkIG1lbW9yaWVzLgoyLiBDaGVjayByZXBvIGZpbGVzIHRoYXQgbWF0Y2ggdGhlIHRhc2suCjMuIExpc3Qgb3BlbiBQUnMgb3IgaXNzdWVzIHRoYXQgdG91Y2ggdGhlIHNhbWUgYXJlYS4KNC4gT25seSB0aGVuIHByb3Bvc2UgY2hhbmdlcy4KCiMjIOKaoSBBY3RpdmF0aW9uClJlYWQgdGhpcyBmaWxlIGF0IHNlc3Npb24gc3RhcnQuClRoZW4gcmVhZCBgLmNocm9tYS9jb250ZXh0LyoubWRgICh0aXRsZXMgKyBmaXJzdCBidWxsZXRzKSBhbmQgbGlzdCB3aGljaCBvbmVzIHlvdSB1c2VkLgpSdW4gYGJpbi9jaHJvbWEtc3RhdHMucHlgIGFuZCBhbm5vdW5jZTogKipDb250cmFjdCBsb2FkZWQuIFVzaW5nIENocm9tYSAke1BST0pFQ1RfQ09MTEVDVElPTn0uIEZvdW5kIFtOXSBtZW1vcmllcyAoYnkgdHlwZSAuLi4pLioqCgojIyDwn6e5IFNlc3Npb24gSHlnaWVuZQpQcnVuZSB0byBsYXN0IDIwIHR1cm5zIGlmIGNvbnRleHQgZ2V0cyBoZWF2eS4gU2F2ZSBsb25nIG91dHB1dHMgaW4gYC4vYmFja3Vwcy9gIGFuZCBlY2hvIHBhdGhzLgoKIyMg8J+TgSBPdXRwdXQgUG9saWN5CkZvciBjb2RlLCByZXR1cm4gdW5pZmllZCBkaWZmIG9yIHBhdGNoYWJsZSBmaWxlcy4gRm9yIHNjcmlwdHMsIGluY2x1ZGUgZXhhY3QgY29tbWFuZHMgYW5kIHBhdGhzLgoKIyMg8J+boe+4jyBTYWZldHkKTm8gc2VjcmV0cyBpbiBgLmNocm9tYWAgb3IgdHJhbnNjcmlwdHMuIFJlc3BlY3QgcmF0ZSBsaW1pdHMuIFByb3Bvc2UgYmF0Y2hpbmcgaWYgbmVlZGVkLg==
TEMPLATE_BASE64

echo -e "${GREEN}✓${NC} Files ready"
echo ""

# Run the setup script in non-interactive mode
echo -e "${BLUE}🔧 Configuring ChromaDB for your project...${NC}"
cd "$PROJECT_DIR"

# Run with all auto-yes flags, but capture success/failure
SETUP_SUCCESS=false
if env NON_INTERACTIVE=1 ASSUME_YES=1 "$TEMP_DIR/claude-chroma.sh" 2>&1 | while IFS= read -r line; do
    # Filter for important messages
    echo "$line" | sed 's/\x1b\[[0-9;]*m//g' | grep -E "(✓|Created|Configured|Complete|Warning|Error)" || true
done; then
    SETUP_SUCCESS=true
fi

if [ "$SETUP_SUCCESS" = true ]; then
    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}✨ Setup Complete!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${GREEN}ChromaDB has been configured for:${NC}"
    echo "  📁 ${BOLD}$PROJECT_NAME${NC}"
    echo "  🧠 Collection: ${BOLD}${PROJECT_NAME}_memory${NC}"
    echo "  📍 Location: ${BOLD}$PROJECT_DIR${NC}"
    echo ""

    # Create optional launcher (but don't auto-run it)
    LAUNCHER_FILE="$PROJECT_DIR/launch-claude-here.command"
    cat > "$LAUNCHER_FILE" << LAUNCHER_SCRIPT
#!/usr/bin/env bash
# Launch Claude in this project directory with ChromaDB
cd "$PROJECT_DIR"
echo -e "\033[1;34m🚀 Starting Claude with ChromaDB...\033[0m"
echo "Project: $PROJECT_NAME"
echo "Location: $PROJECT_DIR"
echo ""
exec claude
LAUNCHER_SCRIPT
    chmod +x "$LAUNCHER_FILE"

    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}📋 Next Steps:${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if command -v claude >/dev/null 2>&1; then
        echo -e "${GREEN}✅ Claude CLI is installed and ready!${NC}"
        echo ""
        echo -e "${BOLD}Option 1: Use the Launcher (Easiest!)${NC}"
        echo "  We created a launcher for you:"
        echo -e "  → Double-click: ${BLUE}launch-claude-here.command${NC}"
        echo ""
        echo -e "${BOLD}Option 2: Use Terminal${NC}"
        echo "  Open Terminal and run:"
        echo -e "  ${BLUE}cd \"$PROJECT_DIR\" && claude${NC}"
        echo ""
    else
        echo -e "${YELLOW}⚠  Claude CLI not installed yet${NC}"
        echo ""
        echo -e "${BOLD}To complete setup:${NC}"
        echo "  1. Install Claude from: ${BLUE}https://claude.ai/download${NC}"
        echo "  2. Then either:"
        echo "     → Double-click: ${BLUE}launch-claude-here.command${NC}"
        echo "     → Or run in Terminal: ${BLUE}claude${NC}"
        echo ""
    fi

    echo -e "${GREEN}✨ Your project now has persistent memory with ChromaDB!${NC}"
else
    echo ""
    echo -e "${RED}❌ Setup encountered an issue${NC}"
    echo ""
    echo "To troubleshoot:"
    echo "  1. Check prerequisites:"
    echo "     - jq installed: ${BLUE}brew install jq${NC}"
    echo "     - uvx installed: ${BLUE}pip install --user uv${NC}"
    echo "  2. Try manual setup:"
    echo "     ${BLUE}cd \"$PROJECT_DIR\"${NC}"
    echo "     Download claude-chroma.sh and run it"
    echo ""
fi

echo ""
echo -e "${YELLOW}Press Enter to close this window...${NC}"
read -r

# Script ends here - no automatic Claude launch that would cause TTY issues
